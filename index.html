<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ZxBiz F1.0 - Personal Edition (Patched)</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#2C263F">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    
    <style>
        /* B·∫¢NG M√ÄU CH√çNH X√ÅC T·ª™ ·∫¢NH CUNG C·∫§P */
        :root {
            --primary: #2C263F;    /* DARK PURPLE */
            --secondary: #595082;  /* ULTRA VIOLET */
            --accent: #F8C662;     /* SAFFRON */
            --success: #41644A;    /* HUNTER GREEN */
            --bg-light: #EAE7F0;   
        }
        body { background-color: var(--primary); color: var(--bg-light); -webkit-tap-highlight-color: transparent; }
        
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .loader { border: 3px solid var(--bg-light); border-top: 3px solid var(--accent); border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        [v-cloak] { display: none !important; }

        #app { background-color: var(--primary) !important; color: var(--bg-light); }

        .board-container { display: flex; gap: 0.8rem; overflow-x: auto; scroll-snap-type: x mandatory; padding-bottom: 0.5rem; scroll-behavior: smooth; }
        .mission-card { min-width: 85vw; max-width: 85vw; scroll-snap-align: center; display: flex; flex-direction: column; max-height: 65vh; border-radius: 1rem; overflow: hidden; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.2); background-color: var(--bg-light); color: var(--primary); }
        @media (min-width: 768px) { .mission-card { min-width: 320px; max-width: 320px; } }
        .mission-body { overflow-y: auto; flex: 1; padding: 0.5rem; }

        .theme-idea { border: 2px solid var(--accent); background-color: #FFF8E1; color: var(--primary); }
        .theme-normal .header { background-color: var(--secondary); color: white; }
        .theme-normal .body { background-color: var(--bg-light); }
        .idea-focus-container { max-height: 80px; overflow-y: auto; }

        /* STATUS STYLES */
        .card-done { border-left: 4px solid var(--secondary); opacity: 0.7; background-color: #F3F0FF; }
        .card-cancel { border-left: 4px solid #9CA3AF; text-decoration: line-through; opacity: 0.6; }
        .card-loop { border-left: 4px solid #8B5CF6; background-color: #F5F3FF; }
        .card-debt { border-left: 4px solid #EF4444; background-color: #FEF2F2; border-right: 1px solid #EF4444; }
        .card-doing { border-left: 4px solid var(--accent); }

        .toast-enter-active, .toast-leave-active { transition: all 0.5s ease; }
        .toast-enter-from, .toast-leave-to { opacity: 0; transform: translateY(-20px); }
    </style>
</head>
<body>
    
    <div id="app" v-cloak class="max-w-md mx-auto min-h-screen shadow-2xl flex flex-col relative transition-all duration-300 pb-20">
        
        <transition name="toast">
            <div v-if="toast.show" class="fixed top-20 left-1/2 transform -translate-x-1/2 z-[150] bg-secondary text-white px-6 py-4 rounded-xl shadow-2xl flex items-center border-2 border-accent min-w-[300px]">
                <div class="mr-3 text-2xl" v-html="toast.icon"></div>
                <div><div class="font-bold text-sm text-accent uppercase mb-1">{{ toast.title }}</div><div class="font-medium text-sm">{{ toast.message }}</div></div>
            </div>
        </transition>

        <div class="bg-secondary text-white p-4 sticky top-0 z-50 shadow-lg flex justify-between items-center">
            <h1 class="font-bold text-lg flex items-center cursor-pointer" @click="scrollToTop">
                <i class="fas fa-rocket mr-2 text-accent"></i>ZxBiz 
                <span v-if="isPlus" class="bg-gradient-to-r from-purple-500 to-pink-500 text-[10px] px-1.5 py-0.5 rounded ml-1 font-bold">PLUS</span>
                <span v-else class="bg-accent text-primary text-[10px] px-1.5 py-0.5 rounded ml-1 font-bold">FREE</span>
            </h1>
            <div class="relative flex items-center">
                <button @click="showMenu = !showMenu" class="p-2 hover:bg-primary/30 rounded-full transition"><i class="fas fa-ellipsis-v"></i></button>
                
                <div v-if="showMenu" class="absolute right-0 top-12 bg-white text-primary shadow-xl rounded-xl w-72 py-2 border border-gray-200 z-50 animate-fade-in origin-top-right">
                    <button @click="togglePlus" class="block w-full text-left px-4 py-2.5 hover:bg-accent/10 font-bold transition" :class="isPlus ? 'text-gray-500' : 'text-purple-600'">
                        <i class="fas mr-2 w-6 text-center" :class="isPlus ? 'fa-toggle-off' : 'fa-crown'"></i> {{ isPlus ? 'Giao di·ªán g·ªçn (3 Tab)' : 'M·ªü r·ªông Studio (5 Tab)' }}
                    </button>
                    <button @click="resetBlocks" class="block w-full text-left px-4 py-2.5 hover:bg-red-50 text-red-500 transition"><i class="fas fa-undo mr-2 w-6 text-center"></i>Reset C·∫•u tr√∫c</button>
                    <button @click="exportData" class="block w-full text-left px-4 py-2.5 hover:bg-accent/10 transition"><i class="fas fa-file-code mr-2 w-6 text-center"></i>Backup d·ªØ li·ªáu (JSON)</button>
                    <label class="block w-full text-left px-4 py-2.5 hover:bg-accent/10 cursor-pointer transition"><i class="fas fa-file-import mr-2 w-6 text-center"></i>Kh√¥i ph·ª•c d·ªØ li·ªáu<input type="file" @change="importData" class="hidden" accept=".json"></label>
                </div>
            </div>
        </div>
        <div v-if="showMenu" @click="showMenu = false" class="fixed inset-0 z-40 bg-black bg-opacity-20"></div>

        <div class="p-4 bg-primary border-b border-white/10 shadow-sm space-y-3">
            <div class="relative">
                <input v-model="quickInput" @keyup.enter="openQuickAddModal" placeholder="T√¨m ki·∫øm ho·∫∑c th√™m nhanh..." class="w-full pl-10 pr-12 py-3 border-2 border-secondary rounded-xl bg-white/10 focus:bg-white focus:text-primary focus:outline-none text-white font-medium shadow-sm transition-all placeholder-white/50">
                <i class="fas fa-search absolute left-3 top-3.5 text-white/70"></i>
                <button @click="openQuickAddModal" class="absolute right-2 top-2 bg-accent text-primary p-1.5 px-3 rounded-lg hover:bg-secondary hover:text-white transition"><i class="fas fa-arrow-up"></i></button>
            </div>
            
            <div @click="showReportModal = true" class="flex gap-4 text-xs font-bold text-white/70 justify-center cursor-pointer hover:bg-white/10 p-2 rounded-lg transition border border-transparent hover:border-white/20">
                <span class="flex items-center"><i class="fas fa-arrow-down text-accent mr-1"></i> {{ formatMoney(stats.income) }}</span>
                <span class="flex items-center"><i class="fas fa-arrow-up text-red-400 mr-1"></i> {{ formatMoney(stats.expense) }}</span>
                <span class="ml-2 text-white opacity-50"><i class="fas fa-chart-pie"></i> Xem b√°o c√°o</span>
            </div>
        </div>

        <div class="flex-1 flex flex-col overflow-hidden space-y-4 overflow-y-auto pb-10 bg-primary">
            <div v-if="loading" class="text-center py-10"><div class="loader mx-auto mb-2"></div></div>
            <div v-else>
                
                <div v-if="ideaMission" class="px-3 mt-3">
                    <div class="w-full bg-[#FFF8E1] border-2 border-accent rounded-xl shadow-sm overflow-hidden flex flex-col">
                        <div class="bg-[#FFF3CD] px-3 py-2 flex justify-between items-center border-b border-accent/30">
                            <span class="text-xs font-bold text-accent uppercase tracking-wider flex items-center"><i class="fas fa-lightbulb mr-1"></i> H·ªòP √ù T∆Ø·ªûNG</span>
                            <span class="text-[10px] text-accent/70 font-bold">{{ ideaMission.tasklists[0]?.todos.length || 0 }} √Ω t∆∞·ªüng</span>
                        </div>
                        <div class="p-2 text-primary">
                            <div class="mb-2 relative"><input @keyup.enter="addIdeaDirectly(ideaMission, $event)" placeholder="üí° Nh·∫≠p √Ω t∆∞·ªüng m·ªõi..." class="w-full text-sm p-3 pr-10 bg-white border border-accent/30 rounded-lg focus:outline-none focus:ring-2 focus:ring-accent text-primary placeholder-accent/50 shadow-inner font-medium"><button class="absolute right-2 top-2 text-accent hover:text-secondary"><i class="fas fa-plus-circle"></i></button></div>
                            <div class="idea-focus-container space-y-2 pr-1 custom-scrollbar">
                                <template v-if="ideaMission.tasklists.length > 0 && ideaMission.tasklists[0].todos.length > 0">
                                    <div v-for="(todo, tIndex) in ideaMission.tasklists[0].todos.slice().reverse()" :key="todo.id" class="p-2 bg-white rounded-lg border border-accent/10 flex justify-between items-center cursor-pointer hover:bg-[#FFF3CD] transition group shadow-sm" @click="openEditModal(ideaMission, 0, (ideaMission.tasklists[0].todos.length - 1 - tIndex), true)">
                                        <span class="text-sm font-medium text-primary truncate flex-1">{{ todo.content }}</span><i class="fas fa-pen text-[10px] text-accent opacity-0 group-hover:opacity-100 transition"></i>
                                    </div>
                                </template>
                                <div v-else class="text-center text-xs text-accent/40 italic py-2">Ch∆∞a c√≥ √Ω t∆∞·ªüng n√†o. H√£y b·∫Øt ƒë·∫ßu s√°ng t·∫°o!</div>
                            </div>
                        </div>
                    </div>
                </div>

                <div v-for="blockIndex in (unlockedBlocks + 1)" :key="blockIndex" class="relative mt-4">
                    <div v-if="blockIndex <= unlockedBlocks">
                        <div class="flex justify-between items-center px-4 mb-2 group">
                            <div class="flex items-center">
                                <h3 class="text-xs font-bold uppercase text-white tracking-wider flex items-center cursor-pointer" @click="editBlockName(blockIndex)">
                                    <span class="text-primary text-[10px] px-2.5 py-1 rounded-md mr-2 transition-all shadow font-black" :class="isPlus ? 'bg-gradient-to-r from-purple-500 to-pink-500 text-white' : 'bg-accent'">{{ getBlockName(blockIndex) }}</span><i class="fas fa-pencil-alt text-[10px] text-white/50 opacity-0 group-hover:opacity-100 transition"></i>
                                </h3>
                                <span class="text-white/50 text-[10px] ml-2 font-mono">{{ getBlockStatus(blockIndex) }}</span>
                            </div>
                            <button v-if="canAddMissionToBlock(blockIndex)" @click="promptAddMission(blockIndex)" class="text-xs bg-secondary/80 text-white px-3 py-1.5 rounded-full hover:bg-accent hover:text-primary shadow-sm transition flex items-center"><i class="fas fa-plus mr-1"></i>Th√™m Mission</button>
                        </div>
                        <div class="board-container no-scrollbar pl-3 pr-3" :id="'block-' + blockIndex">
                            <div v-for="mission in getMissionsForBlock(blockIndex)" :key="mission.id" class="mission-card border shrink-0 theme-normal border-primary/10">
                                
                                <div class="p-3 header flex justify-between items-center sticky top-0 z-10 shadow-sm">
                                    <h2 class="font-bold text-sm truncate uppercase max-w-[70%] flex items-center"><i class="fas fa-flag mr-2 text-accent"></i> {{ mission.title }}</h2>
                                    <div class="flex gap-1 opacity-80 hover:opacity-100 transition">
                                        <button @click="editMissionTitle(mission)" class="p-1.5 hover:bg-white/20 rounded transition" title="S·ª≠a t√™n"><i class="fas fa-pen text-xs"></i></button>
                                        <button @click="deleteMission(mission.id)" class="p-1.5 hover:bg-red-500/80 rounded transition text-red-300 hover:text-white" title="X√≥a Mission"><i class="fas fa-trash text-xs"></i></button>
                                    </div>
                                </div>
                                
                                <div class="px-3 py-2 bg-gray-50 border-b border-gray-100 flex justify-between items-center text-[11px] font-bold font-mono">
                                    <div class="flex items-center text-primary tooltip" title="T·ªïng thu"><i class="fas fa-arrow-down text-accent mr-1"></i> {{ formatMoney(getMissionStats(mission).income) }}</div>
                                    <div class="flex items-center text-primary tooltip" title="T·ªïng chi"><i class="fas fa-arrow-up text-red-400 mr-1"></i> {{ formatMoney(getMissionStats(mission).expense) }}</div>
                                    <div class="flex items-center tooltip" title="L·ª£i nhu·∫≠n r√≤ng" :class="getMissionStats(mission).profit >= 0 ? 'text-green-600' : 'text-red-500'"><span class="mr-1 font-black">=</span> {{ formatMoney(getMissionStats(mission).profit) }}</div>
                                </div>

                                <div class="p-2 bg-[#F0F9F9] border-b border-primary/5 relative"><input @keyup.enter="addTasklist(mission, $event)" placeholder="+ Th√™m nh√≥m vi·ªác..." class="w-full text-xs p-2 pr-8 rounded bg-white border border-primary/10 focus:border-secondary focus:ring-1 focus:ring-secondary outline-none text-primary transition"><i class="fas fa-plus absolute right-4 top-1/2 transform -translate-y-1/2 text-gray-400 text-xs pointer-events-none"></i></div>
                                
                                <div class="mission-body body space-y-4">
                                    <div v-for="(tl, tlIndex) in mission.tasklists" :key="tl.id" class="mb-3">
                                        <div class="flex justify-between items-center mb-2 px-1">
                                            <h4 class="font-bold text-xs text-primary uppercase flex items-center"><i class="fas fa-layer-group mr-1.5 text-secondary/70"></i>{{ tl.title }}</h4>
                                            <div class="flex items-center">
                                                <button @click="createQuote(tl)" class="text-secondary/70 hover:text-accent px-1.5 transition" title="T·∫°o b√°o gi√°/Bill"><i class="fas fa-file-invoice-dollar text-xs"></i></button>
                                                <button @click="editTasklistTitle(mission, tlIndex)" class="text-gray-400 hover:text-primary px-1.5 transition" title="S·ª≠a t√™n nh√≥m"><i class="fas fa-pen text-[10px]"></i></button>
                                                <button @click="deleteTasklist(mission, tlIndex)" class="text-gray-400 hover:text-red-500 px-1.5 transition" title="X√≥a nh√≥m"><i class="fas fa-times text-[10px]"></i></button>
                                            </div>
                                        </div>
                                        <input @keyup.enter="addTodoDirectly(mission, tlIndex, $event)" placeholder="+ Th√™m c√¥ng vi·ªác..." class="w-full text-xs p-2 mb-2 rounded border border-gray-200 bg-white/70 focus:bg-white focus:border-secondary outline-none text-primary transition shadow-sm">
                                        <div class="space-y-2">
                                            <div v-for="(todo, tIndex) in filteredTodos(tl.todos)" :key="todo.id" class="bg-white p-2.5 rounded-lg shadow-sm text-sm cursor-pointer border-l-[5px] transition hover:shadow-md group" 
                                                :class="[
                                                    todo.isLoop ? 'card-loop' : '',
                                                    todo.status === 'done' ? 'card-done' : '',
                                                    todo.status === 'cancel' ? 'card-cancel' : '',
                                                    todo.status === 'debt' ? 'card-debt' : '',
                                                    todo.status === 'doing' ? 'card-doing' : ''
                                                ]" 
                                                @click="openEditModal(mission, tlIndex, tIndex, false)">
                                                <div class="flex justify-between items-start">
                                                    <span class="flex-1 mr-2 text-primary font-medium leading-tight">{{ todo.content }}</span>
                                                    <div class="flex items-center shrink-0 ml-1">
                                                        <button v-if="todo.money != 0" @click.stop="createSingleQuote(todo)" class="text-gray-300 hover:text-primary mr-2 px-1 opacity-0 group-hover:opacity-100 transition" title="Ch·ªët gi√° m√≥n n√†y"><i class="fas fa-receipt text-xs"></i></button>
                                                        
                                                        <span v-if="todo.money" :class="todo.money > 0 ? 'text-primary' : 'text-accent'" class="text-[11px] font-bold bg-gray-100 px-1.5 py-0.5 rounded-md">{{ formatMoney(todo.money) }}</span>
                                                        
                                                        <button v-if="todo.status === 'debt'" @click.stop="copyDebtReminder(todo)" class="ml-2 text-red-500 hover:text-red-700 animate-pulse" title="Copy tin nh·∫Øc n·ª£"><i class="fas fa-bell text-xs"></i></button>
                                                    </div>
                                                </div>
                                                <div v-if="todo.startTime || todo.endTime" class="text-[10px] text-gray-400 mt-1 flex items-center">
                                                    <i class="far fa-calendar-alt mr-1"></i>
                                                    <span v-if="todo.startTime">{{ formatDateSimple(todo.startTime) }}</span>
                                                    <span v-if="todo.startTime && todo.endTime" class="mx-1">-</span>
                                                    <span v-if="todo.endTime">{{ formatDateSimple(todo.endTime) }}</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div v-if="mission.tasklists.length === 0" class="text-center text-xs text-gray-400 italic py-8 flex flex-col items-center"><i class="fas fa-clipboard-list text-2xl mb-2 opacity-50"></i>Ch∆∞a c√≥ nh√≥m vi·ªác n√†o</div>
                                </div>
                            </div>
                            <div v-if="getMissionsForBlock(blockIndex).length === 0" class="mission-card border-2 border-dashed border-white/30 rounded-xl flex flex-col items-center justify-center text-white/50 text-sm bg-white/5 min-h-[250px] hover:bg-white/10 transition cursor-pointer" @click="promptAddMission(blockIndex)"><i class="fas fa-plus-circle text-4xl mb-3 text-accent"></i><span class="font-medium">Block n√†y c√≤n tr·ªëng</span><button class="mt-3 bg-accent text-primary px-4 py-2 rounded-full text-xs font-bold shadow-sm hover:shadow-md transition">Th√™m Mission ngay</button></div>
                        </div>
                    </div>
                    <div v-else class="mt-6 border-t-2 border-dashed border-accent/30 pt-6 px-4 mx-4"><div class="bg-white/10 rounded-2xl shadow-xl border-2 border-accent p-8 text-center relative overflow-hidden"><div class="absolute top-0 right-0 bg-accent text-primary text-xs font-bold px-3 py-1.5 rounded-bl shadow-sm">STORE</div><i class="fas fa-lock text-5xl text-white mb-4 opacity-80"></i><h3 class="text-xl font-bold text-white uppercase mb-2">M·ªü kh√≥a Block {{ blockIndex }}</h3><p class="text-white/70 text-sm mb-4">M·ªü r·ªông kh√¥ng gian l√†m vi·ªác c·ªßa b·∫°n.</p><button @click="unlockNextBlock" class="w-full bg-accent text-primary py-3.5 rounded-xl font-bold shadow-lg mt-2 hover:bg-[#FFD54F] transition transform active:scale-95 flex items-center justify-center"><i class="fas fa-unlock mr-2"></i>Mua ngay (Demo)</button></div></div>
                </div>
            </div>
        </div>

        <div v-if="showReportModal" class="fixed inset-0 z-[120] flex items-center justify-center bg-black bg-opacity-80 p-4 backdrop-blur-md transition-all" @click="showReportModal = false">
            <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md overflow-hidden animate-fade-in flex flex-col max-h-[90vh]" @click.stop>
                <div class="bg-secondary p-4 text-white font-bold flex justify-between items-center sticky top-0 z-10"><span class="text-lg flex items-center"><i class="fas fa-chart-pie mr-2 text-accent"></i> B√°o c√°o Thu Chi</span><button @click="showReportModal = false" class="text-white/80 hover:text-white w-8 h-8 flex items-center justify-center rounded-full hover:bg-white/20 transition"><i class="fas fa-times"></i></button></div>
                <div class="overflow-y-auto p-5 space-y-5 bg-gray-50">
                    <div class="bg-white p-5 rounded-2xl shadow-sm border border-gray-100 text-center relative overflow-hidden">
                        <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-accent to-secondary"></div>
                        <div class="text-xs text-gray-500 font-bold uppercase mb-3 tracking-wider">L·ª£i nhu·∫≠n r√≤ng (Net Profit)</div>
                        <div class="text-4xl font-black my-2" :class="(stats.income - stats.expense) >= 0 ? 'text-green-600' : 'text-red-500'">{{ formatMoney(stats.income - stats.expense) }}</div>
                        <div class="flex justify-between mt-6 text-sm px-2 bg-gray-50 p-3 rounded-xl">
                            <div class="text-primary font-bold flex flex-col"><span class="text-[10px] text-gray-400 uppercase font-medium mb-1">T·ªïng thu</span><span class="flex items-center text-green-600"><i class="fas fa-arrow-down text-accent mr-1.5"></i> {{ formatMoney(stats.income) }}</span></div>
                            <div class="h-10 w-px bg-gray-200"></div>
                            <div class="text-red-500 font-bold flex flex-col text-right"><span class="text-[10px] text-gray-400 uppercase font-medium mb-1">T·ªïng chi</span><span class="flex items-center justify-end"><i class="fas fa-arrow-up mr-1.5"></i> {{ formatMoney(stats.expense) }}</span></div>
                        </div>
                    </div>
                    <div>
                    <div class="text-xs font-bold text-primary uppercase border-b border-gray-200 pb-2 mb-3 flex items-center"><i class="fas fa-list-ul mr-2 text-secondary"></i>Chi ti·∫øt theo Mission</div>
                    <div v-if="missionReports.length > 0" class="space-y-3">
                        <div v-for="report in missionReports" :key="report.title" class="bg-white border border-gray-200 rounded-xl p-3 shadow-sm hover:shadow-md transition">
                            <div class="flex justify-between items-center mb-2.5"><div class="font-bold text-primary text-sm truncate max-w-[60%] flex items-center"><i class="fas fa-flag text-xs text-secondary/70 mr-2"></i>{{ report.title }}</div><div class="font-black text-sm px-2 py-0.5 rounded-md" :class="report.profit >= 0 ? 'text-green-700 bg-green-50' : 'text-red-700 bg-red-50'">{{ report.profit > 0 ? '+' : '' }}{{ formatMoney(report.profit) }}</div></div>
                            <div class="h-2 w-full bg-gray-100 rounded-full overflow-hidden flex mb-2.5"><div v-if="report.income > 0" class="h-full bg-accent" :style="{ width: (report.income / (report.income + report.expense || 1) * 100) + '%' }"></div><div v-if="report.expense > 0" class="h-full bg-red-400" :style="{ width: (report.expense / (report.income + report.expense || 1) * 100) + '%' }"></div></div>
                            <div class="flex justify-between text-[11px] text-gray-500 font-mono bg-gray-50 p-1.5 rounded-lg"><span>Thu: <span class="font-bold text-primary">{{ formatMoney(report.income) }}</span></span><span>Chi: <span class="font-bold text-red-500">{{ formatMoney(report.expense) }}</span></span></div>
                        </div>
                    </div>
                    <div v-else class="text-center text-gray-400 text-sm py-8 flex flex-col items-center"><i class="fas fa-file-invoice text-3xl mb-2 opacity-50"></i>Ch∆∞a c√≥ d·ªØ li·ªáu t√†i ch√≠nh</div>
                    </div>
                </div>
            </div>
        </div>

        <div v-if="editingTodo" class="fixed inset-0 z-[60] flex items-center justify-center bg-black bg-opacity-70 p-4 backdrop-blur-md transition-all"><div class="bg-white rounded-2xl shadow-2xl w-full max-w-md overflow-hidden animate-fade-in border-2 border-secondary flex flex-col max-h-[95vh]"><div class="bg-secondary p-4 text-white font-bold flex justify-between items-center shrink-0"><span class="text-lg flex items-center"><i class="fas mr-2" :class="editingTodo.isIdea ? 'fa-lightbulb text-accent' : 'fa-edit'"></i> {{ editingTodo.isIdea ? 'Chi ti·∫øt √ù t∆∞·ªüng' : 'Ch·ªânh s·ª≠a C√¥ng vi·ªác' }}</span><button @click="closeEditModal" class="text-white/80 hover:text-white w-8 h-8 flex items-center justify-center rounded-full hover:bg-white/20 transition"><i class="fas fa-times"></i></button></div><div class="p-6 space-y-5 overflow-y-auto text-primary bg-gray-50"><div><label class="block text-xs font-bold text-primary uppercase mb-1.5 ml-1">N·ªôi dung</label><textarea v-model="editForm.content" rows="2" class="w-full p-3 border border-primary/20 rounded-xl bg-white text-primary focus:ring-2 focus:ring-secondary focus:border-transparent outline-none font-bold text-base shadow-sm resize-none"></textarea></div><template v-if="!editingTodo.isIdea"><div class="flex items-center justify-between bg-white p-4 rounded-xl border border-[#8B5CF6]/30 shadow-sm"><span class="text-sm font-bold text-primary flex items-center"><i class="fas fa-sync-alt text-[#8B5CF6] mr-3 text-lg"></i> C√¥ng vi·ªác l·∫∑p l·∫°i?</span><label class="relative inline-flex items-center cursor-pointer"><input type="checkbox" v-model="editForm.isLoop" class="sr-only peer"><div class="w-12 h-7 bg-gray-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-6 after:w-6 after:transition-all peer-checked:bg-[#8B5CF6] shadow-inner"></div></label></div><div v-if="editForm.isLoop" class="bg-[#F5F3FF] p-4 rounded-xl border border-[#8B5CF6]/30 shadow-sm animate-fade-in"><button @click="checkInLoop" class="w-full bg-[#8B5CF6] text-white py-3 rounded-xl font-bold shadow-md hover:bg-[#7C3AED] mb-4 transition transform active:scale-95 flex items-center justify-center"><i class="fas fa-check-circle mr-2 text-xl"></i>Ghi nh·∫≠n h√¥m nay</button><div class="text-xs font-bold text-[#8B5CF6] uppercase mb-2 ml-1">L·ªãch s·ª≠ ghi nh·∫≠n</div><div class="max-h-32 overflow-y-auto text-sm space-y-2 custom-scrollbar pr-1"><div v-for="(log, idx) in (editForm.logs || []).slice().reverse()" :key="idx" class="text-primary flex justify-between items-center bg-white p-2 rounded-lg border border-[#8B5CF6]/10 shadow-sm"><span class="font-medium">{{ formatDateFull(log) }}</span><span class="text-[#8B5CF6] bg-[#F5F3FF] p-1 rounded-full"><i class="fas fa-check text-xs"></i></span></div></div></div><div class="flex gap-4" v-if="!editForm.isLoop"><div class="flex-1"><label class="block text-xs font-bold text-primary uppercase mb-1.5 ml-1">S·ªë ti·ªÅn (VNƒê)</label><div class="relative"><input type="number" v-model.number="editForm.money" placeholder="0" class="w-full p-3 pl-8 border border-primary/20 rounded-xl bg-white text-primary font-mono font-bold focus:ring-2 focus:ring-secondary focus:border-transparent outline-none shadow-sm"><i class="fas fa-coins absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i></div></div><div class="flex-1"><label class="block text-xs font-bold text-primary uppercase mb-1.5 ml-1">Tr·∫°ng th√°i</label><div class="relative"><select v-model="editForm.status" class="w-full p-3 pl-8 border border-primary/20 rounded-xl bg-white text-primary font-medium focus:ring-2 focus:ring-secondary focus:border-transparent outline-none shadow-sm appearance-none"><option value="doing">ƒêang l√†m</option><option value="done">Ho√†n th√†nh</option><option value="debt" class="text-red-500 font-bold">‚ùó Kh√°ch n·ª£</option><option value="pause">T·∫°m d·ª´ng</option><option value="cancel">ƒê√£ h·ªßy</option></select><i class="fas fa-info-circle absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i><i class="fas fa-chevron-down absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 text-xs pointer-events-none"></i></div></div></div><div class="flex gap-4"><div class="flex-1"><label class="block text-xs font-bold text-primary uppercase mb-1.5 ml-1">B·∫Øt ƒë·∫ßu</label><div class="relative"><input type="date" v-model="editForm.startTime" class="w-full p-3 pl-8 border border-primary/20 rounded-xl bg-white text-primary focus:ring-2 focus:ring-secondary focus:border-transparent outline-none shadow-sm"><i class="far fa-calendar-alt absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i></div></div><div class="flex-1"><label class="block text-xs font-bold text-primary uppercase mb-1.5 ml-1">K·∫øt th√∫c</label><div class="relative"><input type="date" v-model="editForm.endTime" class="w-full p-3 pl-8 border border-primary/20 rounded-xl bg-white text-primary focus:ring-2 focus:ring-secondary focus:border-transparent outline-none shadow-sm"><i class="far fa-calendar-check absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i></div></div></div></template><div><label class="block text-xs font-bold text-primary uppercase mb-1.5 ml-1">Ghi ch√∫</label><textarea v-model="editForm.note" rows="3" placeholder="Th√™m ghi ch√∫ chi ti·∫øt..." class="w-full p-3 border border-primary/20 rounded-xl bg-white text-primary text-sm focus:ring-2 focus:ring-secondary focus:border-transparent outline-none shadow-sm resize-none"></textarea></div><div class="flex gap-3 pt-3 border-t border-gray-200"><button @click="deleteEditingTodo" class="flex-none bg-red-50 text-red-500 p-3 rounded-xl font-bold hover:bg-red-100 transition w-12 h-12 flex items-center justify-center shadow-sm" title="X√≥a"><i class="fas fa-trash"></i></button><button @click="saveEdit" class="flex-1 w-full bg-secondary text-white p-3 rounded-xl font-bold shadow-md hover:bg-primary transition transform active:scale-95 flex items-center justify-center"><i class="fas fa-save mr-2"></i> L∆∞u thay ƒë·ªïi</button></div><div class="bg-white p-4 rounded-xl border border-primary/10 shadow-sm mt-2"><div class="text-xs font-bold text-primary uppercase mb-3 flex items-center"><i class="fas fa-exchange-alt mr-2 text-secondary"></i> Di chuy·ªÉn c√¥ng vi·ªác</div><div class="space-y-3"><div class="relative"><select v-model="moveTarget.missionId" @change="onMoveMissionChange" class="w-full p-2.5 pl-8 text-sm border border-primary/20 rounded-lg bg-white focus:ring-2 focus:ring-secondary focus:border-transparent outline-none shadow-sm appearance-none"><option value="" disabled>Ch·ªçn Mission ƒë√≠ch...</option><option v-for="m in normalMissions" :key="m.id" :value="m.id">{{ m.title }}</option></select><i class="fas fa-flag absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400 text-xs"></i><i class="fas fa-chevron-down absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 text-xs pointer-events-none"></i></div><div class="relative" v-if="moveTarget.missionId"><select v-model="moveTarget.tasklistId" class="w-full p-2.5 pl-8 text-sm border border-primary/20 rounded-lg bg-white focus:ring-2 focus:ring-secondary focus:border-transparent outline-none shadow-sm appearance-none"><option value="" disabled>Ch·ªçn Nh√≥m vi·ªác ƒë√≠ch...</option><option v-for="tl in targetTasklists" :key="tl.id" :value="tl.id">{{ tl.title }}</option></select><i class="fas fa-layer-group absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400 text-xs"></i><i class="fas fa-chevron-down absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 text-xs pointer-events-none"></i></div><button v-if="moveTarget.tasklistId" @click="moveTodo" class="w-full bg-secondary/90 text-white py-2.5 rounded-lg text-sm font-bold hover:bg-primary transition shadow-md flex items-center justify-center"><i class="fas fa-share mr-2"></i>Chuy·ªÉn ngay</button></div></div></div></div></div>
        
        <div v-if="showQuickAddModal" class="fixed inset-0 z-[100] flex items-center justify-center bg-black bg-opacity-80 p-4 backdrop-blur-md transition-all"><div class="bg-white rounded-2xl shadow-2xl w-full max-w-sm overflow-hidden animate-fade-in border-2 border-secondary"><div class="bg-secondary p-4 text-white font-bold flex justify-between items-center"><span class="text-lg flex items-center"><i class="fas fa-plus-circle mr-2 text-accent"></i> Th√™m nhanh</span><button @click="showQuickAddModal = false" class="text-white/80 hover:text-white w-8 h-8 flex items-center justify-center rounded-full hover:bg-white/20 transition"><i class="fas fa-times"></i></button></div><div class="p-6 space-y-5 text-primary bg-gray-50"><div><label class="block text-xs font-bold text-primary uppercase mb-1.5 ml-1">N·ªôi dung c√¥ng vi·ªác</label><input v-model="quickAddForm.content" class="w-full p-3 border border-primary/20 rounded-xl bg-white text-primary focus:ring-2 focus:ring-secondary focus:border-transparent outline-none font-bold text-lg shadow-sm" placeholder="Nh·∫≠p n·ªôi dung..."></div><div><label class="block text-xs font-bold text-primary uppercase mb-1.5 ml-1">Ch·ªçn M·ª•c ti√™u (Mission)</label><div class="relative"><select v-model="quickAddForm.missionId" @change="onMissionChange" class="w-full p-3 pl-8 border border-primary/20 rounded-xl bg-white text-primary font-medium focus:ring-2 focus:ring-secondary focus:border-transparent outline-none shadow-sm appearance-none"><option v-for="m in normalMissions" :key="m.id" :value="m.id">{{ m.title }}</option></select><i class="fas fa-flag absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i><i class="fas fa-chevron-down absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 text-xs pointer-events-none"></i></div></div><div v-if="selectedMissionHasTasklists"><label class="block text-xs font-bold text-primary uppercase mb-1.5 ml-1">Ch·ªçn Nh√≥m vi·ªác</label><div class="relative"><select v-model="quickAddForm.tasklistId" class="w-full p-3 pl-8 border border-primary/20 rounded-xl bg-white text-primary font-medium focus:ring-2 focus:ring-secondary focus:border-transparent outline-none shadow-sm appearance-none"><option v-for="tl in availableTasklists" :key="tl.id" :value="tl.id">{{ tl.title }}</option></select><i class="fas fa-layer-group absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i><i class="fas fa-chevron-down absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 text-xs pointer-events-none"></i></div></div><div class="pt-3"><button @click="saveQuickAdd" class="w-full bg-secondary text-white py-3.5 rounded-xl font-bold shadow-lg hover:bg-primary transition transform active:scale-95 flex items-center justify-center"><i class="fas fa-check mr-2"></i>T·∫°o & Nh·∫≠p chi ti·∫øt</button></div></div></div></div>
        
        <div v-if="showCelebrationModal" class="fixed inset-0 z-[110] flex items-center justify-center bg-black bg-opacity-90 p-4 animate-fade-in backdrop-blur-sm" @click="showCelebrationModal = false"><div class="bg-gradient-to-br from-secondary to-primary rounded-3xl shadow-2xl w-full max-w-sm text-center p-8 border-4 border-accent relative overflow-hidden transform transition-all scale-100" @click.stop><div class="absolute inset-0 bg-[url('https://www.transparenttextures.com/patterns/stardust.png')] opacity-20 animate-pulse"></div><div class="relative z-10"><i class="fas fa-trophy text-7xl text-accent mb-6 animate-bounce drop-shadow-[0_5px_5px_rgba(0,0,0,0.5)] inline-block"></i><h2 class="text-4xl font-black text-white mb-3 uppercase tracking-wider drop-shadow-md">TUY·ªÜT V·ªúI!</h2><p class="text-white/90 text-xl mb-8 font-medium leading-relaxed drop-shadow" v-text="celebrationMessage"></p><div class="bg-white/10 rounded-2xl p-5 mb-8 backdrop-blur-sm border border-white/20 shadow-inner"><p class="text-sm text-accent/80 uppercase tracking-widest font-bold mb-2">ƒê√£ ho√†n th√†nh xu·∫•t s·∫Øc</p><p class="text-2xl font-black text-white tracking-wide truncate" v-text="completedMissionTitle"></p></div><button @click="showCelebrationModal = false" class="bg-accent text-primary px-10 py-4 rounded-full font-black shadow-xl hover:bg-[#FFD54F] transition transform hover:scale-105 active:scale-95 flex items-center mx-auto"><i class="fas fa-star mr-2"></i>Ti·∫øp t·ª•c chi·∫øn!</button></div></div></div>
    </div>

    <script type="module">
        import { createApp } from 'https://unpkg.com/vue@3/dist/vue.esm-browser.js';
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js';
        import { getFirestore, collection, addDoc, onSnapshot, doc, updateDoc, deleteDoc, query, orderBy, where } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js';

        const firebaseConfig = { apiKey: "AIzaSyDFFeWWNoL3jZrv9FqLwnnbXv8p8eRyF5g", authDomain: "zxtodo-39f87.firebaseapp.com", projectId: "zxtodo-39f87", storageBucket: "zxtodo-39f87.firebasestorage.app", messagingSenderId: "1020484648812", appId: "1:1020484648812:web:83cadd3c7943d87472bd49" };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        createApp({
            data() {
                return {
                    showMenu: false, newMissionTitle: '', quickInput: '', filterStatus: 'all', missions: [], loading: true, editingTodo: null,
                    editForm: { content: '', money: 0, status: 'doing', note: '', startTime: '', endTime: '', isLoop: false, logs: [] },
                    showQuickAddModal: false, quickAddForm: { content: '', missionId: '', tasklistId: '' },
                    toast: { show: false, message: '', icon: '', title: '' }, showCelebrationModal: false, celebrationMessage: '', completedMissionTitle: '',
                    moveTarget: { missionId: '', tasklistId: '' },
                    unlockedBlocks: 1, isPlus: false, blockNames: {}, showReportModal: false,
                }
            },
            computed: {
                ideaMission() { return this.missions.find(m => m.title.includes("H·ªôp √Ω t∆∞·ªüng")) || null; },
                normalMissions() { return this.missions.filter(m => !m.title.includes("H·ªôp √Ω t∆∞·ªüng")); },
                missionsPerBlock() { return this.isPlus ? 5 : 3; },
                maxCapacity() { return this.unlockedBlocks * this.missionsPerBlock; },
                stats() { let income = 0, expense = 0; this.missions.forEach(m => { if(m.title.includes('H·ªôp √Ω t∆∞·ªüng')) return; m.tasklists.forEach(tl => tl.todos.forEach(t => { if(t.money > 0) income += t.money; if(t.money < 0) expense += Math.abs(t.money); })); }); return { income, expense }; },
                missionReports() { return this.normalMissions.map(m => { let inc = 0, exp = 0; m.tasklists.forEach(tl => tl.todos.forEach(t => { if(t.money > 0) inc += t.money; if(t.money < 0) exp += Math.abs(t.money); })); return { title: m.title, income: inc, expense: exp, profit: inc - exp }; }).sort((a,b) => b.profit - a.profit); },
                selectedMission() { return this.missions.find(m => m.id === this.quickAddForm.missionId); },
                selectedMissionHasTasklists() { return this.selectedMission && this.selectedMission.tasklists && this.selectedMission.tasklists.length > 0; },
                availableTasklists() { return this.selectedMission ? this.selectedMission.tasklists : []; },
                targetMission() { return this.missions.find(m => m.id === this.moveTarget.missionId); },
                targetTasklists() { return this.targetMission ? this.targetMission.tasklists : []; }
            },
            mounted() {
                // T·ª∞ ƒê·ªòNG LOAD D·ªÆ LI·ªÜU KH√îNG C·∫¶N LOGIN
                this.loadData();
                window.addEventListener('keydown', this.handleKeyNav);
            },
            unmounted() {
                window.removeEventListener('keydown', this.handleKeyNav);
            },
            methods: {
                loadData() {
                    if(localStorage.getItem('zx_unlocked_blocks')) this.unlockedBlocks = parseInt(localStorage.getItem('zx_unlocked_blocks'));
                    if(localStorage.getItem('zx_is_plus')) this.isPlus = localStorage.getItem('zx_is_plus') === 'true';
                    if(localStorage.getItem('zx_block_names')) this.blockNames = JSON.parse(localStorage.getItem('zx_block_names'));
                    
                    // QUERY T·∫§T C·∫¢ D·ªÆ LI·ªÜU (KH√îNG PH√ÇN BI·ªÜT USER)
                    const q = query(collection(db, "missions"), orderBy("createdAt", "desc"));
                    
                    this.loading = true;
                    onSnapshot(q, (snapshot) => {
                        let list = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                        this.missions = list;
                        if(!list.find(m => m.title.includes("H·ªôp √Ω t∆∞·ªüng"))) {
                            addDoc(collection(db, "missions"), {
                                title: "H·ªôp √Ω t∆∞·ªüng",
                                tasklists: [{id: 'tldefault', title: '√ù t∆∞·ªüng', todos:[]}],
                                createdAt: Date.now()
                            });
                        }
                        this.loading = false;
                    });
                },

                handleKeyNav(e) { const active = document.activeElement; if (active && (active.tagName === 'INPUT' || active.tagName === 'TEXTAREA' || active.isContentEditable)) return; if (this.showQuickAddModal || this.editingTodo || this.showCelebrationModal || this.showReportModal) return; if (e.key === 'ArrowRight' || e.key === 'ArrowLeft') { e.preventDefault(); const direction = e.key === 'ArrowRight' ? 1 : -1; const scrollAmount = 340 * direction; document.querySelectorAll('.board-container').forEach(container => container.scrollBy({ left: scrollAmount, behavior: 'smooth' })); } },
                generateId() { return Date.now().toString(36) + Math.random().toString(36).substr(2); },
                formatMoney(value) { return new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format(value); },
                formatDateSimple(dateStr) { if(!dateStr) return ''; const d = new Date(dateStr); return `${d.getDate()}/${d.getMonth()+1}`; },
                formatDateFull(dateStr) { if(!dateStr) return ''; const d = new Date(dateStr); return `${d.getDate()}/${d.getMonth()+1} ${d.getHours()}:${d.getMinutes()}`; },
                scrollToTop() { window.scrollTo({ top: 0, behavior: 'smooth' }); },
                getMissionsForBlock(blockIndex) { const start = (blockIndex - 1) * this.missionsPerBlock; return this.normalMissions.slice(start, start + this.missionsPerBlock); },
                canAddMissionToBlock(blockIndex) { return this.getMissionsForBlock(blockIndex).length < this.missionsPerBlock; },
                getBlockStatus(blockIndex) { return `${this.getMissionsForBlock(blockIndex).length}/${this.missionsPerBlock}`; },
                getBlockName(index) { return this.blockNames[index] || `BLOCK ${index}`; },
                editBlockName(index) { const current = this.blockNames[index] || `BLOCK ${index}`; const newName = prompt("ƒê·∫∑t t√™n cho Block n√†y:", current); if(newName && newName.trim()) { this.blockNames[index] = newName.trim(); localStorage.setItem('zx_block_names', JSON.stringify(this.blockNames)); } },
                togglePlus() { this.isPlus = !this.isPlus; localStorage.setItem('zx_is_plus', this.isPlus); this.showMenu = false; this.showToast(this.isPlus ? "ƒê√£ n√¢ng c·∫•p l√™n g√≥i Plus (5 tab)" : "ƒê√£ v·ªÅ g√≥i C∆° b·∫£n (3 tab)", '<i class="fas fa-exchange-alt"></i>', "Chuy·ªÉn ƒë·ªïi"); if(this.isPlus) this.triggerConfetti(1, 'gold'); },
                promptAddMission(blockIndex) { const t = prompt(`Nh·∫≠p t√™n Mission m·ªõi cho ${this.getBlockName(blockIndex)}:`); if(t) this.addMission(t); },
                unlockNextBlock() { this.unlockedBlocks++; localStorage.setItem('zx_unlocked_blocks', this.unlockedBlocks); this.triggerConfetti(2, 'gold'); this.showToast(`ƒê√£ m·ªü kh√≥a Block ${this.unlockedBlocks}!`, '<i class="fas fa-lock-open"></i>', "Th√†nh c√¥ng"); },
                resetBlocks() { this.unlockedBlocks = 1; localStorage.setItem('zx_unlocked_blocks', 1); localStorage.removeItem('zx_block_names'); this.blockNames={}; this.showMenu = false; alert("ƒê√£ reset"); },
                
                getMissionStats(mission) {
                    let income = 0, expense = 0;
                    if (mission.tasklists) { mission.tasklists.forEach(tl => { if (tl.todos) { tl.todos.forEach(t => { if (t.money > 0) income += t.money; if (t.money < 0) expense += Math.abs(t.money); }); } }); }
                    return { income, expense, profit: income - expense };
                },

                createQuote(tasklist) {
                    if (!tasklist || !tasklist.todos) return;
                    let text = `üìã B√ÅO GI√Å: ${tasklist.title.toUpperCase()}\n----------------\n`;
                    let total = 0; let hasItems = false;
                    tasklist.todos.forEach((t, idx) => { if (t.status !== 'cancel' && t.money > 0) { text += `${idx + 1}. ${t.content}: ${this.formatMoney(t.money)}\n`; total += t.money; hasItems = true; } });
                    if (!hasItems) { alert("Ch∆∞a c√≥ c√¥ng vi·ªác n√†o c√≥ ph√≠!"); return; }
                    text += `----------------\nüí∞ T·ªîNG C·ªòNG: ${this.formatMoney(total)}`;
                    navigator.clipboard.writeText(text).then(() => { this.showToast("ƒê√£ copy b√°o gi√°!", '<i class="fas fa-file-invoice-dollar"></i>', "S·∫µn s√†ng g·ª≠i"); });
                },

                createSingleQuote(todo) {
                    const text = `üõí D·ªäCH V·ª§: ${todo.content}\nüí∞ GI√Å: ${this.formatMoney(todo.money)}`;
                    navigator.clipboard.writeText(text).then(() => { this.showToast("ƒê√£ ch·ªët gi√° m√≥n n√†y!", '<i class="fas fa-receipt"></i>', "Copy th√†nh c√¥ng"); });
                },

                copyDebtReminder(todo) {
                    const text = `üëã Ch√†o b·∫°n,\nM√¨nh xin ph√©p nh·∫Øc l·∫°i kho·∫£n thanh to√°n cho vi·ªác: "${todo.content}".\nS·ªë ti·ªÅn: ${this.formatMoney(todo.money)}.\nB·∫°n xem v√† chuy·ªÉn kho·∫£n s·ªõm gi√∫p m√¨nh nh√©! C·∫£m ∆°n b·∫°n.`;
                    navigator.clipboard.writeText(text).then(() => { this.showToast("ƒê√£ copy tin nh·∫Øc n·ª£!", '<i class="fas fa-bell"></i>', "Nh·∫Øc nh·∫π nh√†ng"); });
                },

                async addMission(title = null) {
                    if (this.normalMissions.length >= this.maxCapacity) { alert(`ƒê√£ h·∫øt ch·ªó tr·ªëng!`); return; }
                    const finalTitle = typeof title === 'string' ? title : this.newMissionTitle;
                    if (!finalTitle || !finalTitle.trim()) return;
                    await addDoc(collection(db, "missions"), {
                        title: finalTitle,
                        tasklists: [],
                        createdAt: Date.now()
                    });
                    this.newMissionTitle = '';
                },
                async updateMission(mission) { const { id, ...data } = mission; await updateDoc(doc(db, "missions", id), data); },
                
                // --- PATCH: X·ª¨ L√ù L·ªñI X√ìA MISSION ---
                async deleteMission(id) {
                    if (!id) return;
                    if (!confirm('‚ö†Ô∏è C·∫¢NH B√ÅO: B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a Mission n√†y v√† to√†n b·ªô d·ªØ li·ªáu b√™n trong? H√†nh ƒë·ªông n√†y KH√îNG th·ªÉ ph·ª•c h·ªìi.')) return;
                    
                    try {
                        this.showToast("ƒêang x√≥a d·ªØ li·ªáu...", '<i class="fas fa-spinner fa-spin"></i>', "ƒêang x·ª≠ l√Ω");
                        await deleteDoc(doc(db, "missions", id));
                        this.showToast("ƒê√£ x√≥a th√†nh c√¥ng!", '<i class="fas fa-trash-alt"></i>', "Ho√†n t·∫•t");
                        this.triggerConfetti(0.5, 'regular');
                    } catch (error) {
                        console.error("L·ªói x√≥a Mission:", error);
                        alert("‚ùå L·ªói: Kh√¥ng th·ªÉ x√≥a Mission!\n\nChi ti·∫øt: " + error.message + "\n\n(Vui l√≤ng ki·ªÉm tra tab Rules tr√™n Firebase Console)");
                    }
                },
                // --- END PATCH ---

                async editMissionTitle(mission) { const t = prompt("T√™n m·ªõi:", mission.title); if(t) { mission.title = t; await this.updateMission(mission); } },
                async editTasklistTitle(mission, tlIndex) { const t = prompt("T√™n nh√≥m m·ªõi:", mission.tasklists[tlIndex].title); if(t) { mission.tasklists[tlIndex].title = t; await this.updateMission(mission); } },
                openQuickAddModal() { if (!this.quickInput.trim()) return; let defaultMissionId = ''; if (this.normalMissions.length > 0) defaultMissionId = this.normalMissions[0].id; this.quickAddForm = { content: this.quickInput, missionId: defaultMissionId, tasklistId: '' }; this.updateTasklistSelection(); this.showQuickAddModal = true; },
                onMissionChange() { this.updateTasklistSelection(); },
                updateTasklistSelection() { if (this.selectedMission && this.selectedMission.tasklists.length > 0) this.quickAddForm.tasklistId = this.selectedMission.tasklists[0].id; else this.quickAddForm.tasklistId = ''; },
                async saveQuickAdd() { const form = this.quickAddForm; const mission = this.missions.find(m => m.id === form.missionId); if (!mission) return; const isIdeaBox = mission.title.includes("H·ªôp √Ω t∆∞·ªüng"); const status = isIdeaBox ? 'idea' : 'doing'; const newItem = { id: this.generateId(), content: form.content, money: 0, status: status, note: '', startTime: isIdeaBox ? '' : new Date().toISOString().slice(0, 10), endTime: '', isLoop: false, logs: [] }; let targetTlIndex = 0; if (mission.tasklists.length === 0) mission.tasklists.push({ id: this.generateId(), title: isIdeaBox ? "√ù t∆∞·ªüng" : "Chung", todos: [] }); else if (form.tasklistId) { const idx = mission.tasklists.findIndex(tl => tl.id === form.tasklistId); if(idx !== -1) targetTlIndex = idx; } mission.tasklists[targetTlIndex].todos.push(newItem); await this.updateMission(mission); this.quickInput = ''; this.showQuickAddModal = false; const newIndex = mission.tasklists[targetTlIndex].todos.length - 1; this.openEditModal(mission, targetTlIndex, newIndex, isIdeaBox); },
                async addTodoDirectly(mission, tlIndex, event) { const content = event.target.value.trim(); if (!content) return; const newItem = { id: this.generateId(), content: content, money: 0, status: 'doing', note: '', startTime: new Date().toISOString().slice(0, 10), endTime: '', isLoop: false, logs: [] }; mission.tasklists[tlIndex].todos.push(newItem); await this.updateMission(mission); event.target.value = ''; const newIndex = mission.tasklists[tlIndex].todos.length - 1; this.openEditModal(mission, tlIndex, newIndex, false); },
                async addIdeaDirectly(mission, event) { const content = event.target.value.trim(); if (!content) return; if(mission.tasklists.length === 0) mission.tasklists.push({ id: this.generateId(), title: "√ù t∆∞·ªüng", todos: [] }); const newItem = { id: this.generateId(), content: content, money: 0, status: 'idea', note: '', startTime: '', endTime: '' }; mission.tasklists[0].todos.push(newItem); await this.updateMission(mission); event.target.value = ''; const newIndex = mission.tasklists[0].todos.length - 1; this.openEditModal(mission, 0, newIndex, true); },
                openEditModal(mission, tlIndex, tIndex, isIdea) { const todo = mission.tasklists[tlIndex].todos[tIndex]; this.editingTodo = { mission, tlIndex, tIndex, isIdea: isIdea }; this.editForm = { ...todo, note: todo.note || '', startTime: todo.startTime ? todo.startTime.slice(0,10) : '', endTime: todo.endTime ? todo.endTime.slice(0,10) : '', isLoop: !!todo.isLoop, logs: todo.logs || [] }; this.moveTarget = { missionId: '', tasklistId: '' }; },
                closeEditModal() { this.editingTodo = null; },
                async checkInLoop() { if (!this.editForm.logs) this.editForm.logs = []; this.editForm.logs.push(new Date().toISOString()); await this.saveEdit(); this.triggerConfetti(0.5, 'regular'); this.showToast("Gi·ªØ v·ªØng phong ƒë·ªô nh√©!", '<i class="fas fa-check-circle"></i>', "ƒê√£ ghi nh·∫≠n"); },
                triggerConfetti(intensity, type) { if (typeof confetti === 'function') { if (type === 'gold') { const defaults = { spread: 360, ticks: 100, gravity: 0, decay: 0.94, startVelocity: 30, shapes: ['star'], colors: ['#FFE400', '#FFBD00', '#E89400', '#FFCA6C', '#FDFFB8'] }; function shoot() { confetti({ ...defaults, particleCount: 40, scalar: 1.2, shapes: ['star'] }); confetti({ ...defaults, particleCount: 10, scalar: 0.75, shapes: ['circle'] }); } setTimeout(shoot, 0); setTimeout(shoot, 100); setTimeout(shoot, 200); } else { confetti({ particleCount: intensity * 100, spread: 70, origin: { y: 0.6 } }); } } },
                showToast(msg, icon = '<i class="fas fa-crown"></i>', title = "Tuy·ªát v·ªùi") { this.toast.message = msg; this.toast.icon = icon; this.toast.title = title; this.toast.show = true; setTimeout(() => this.toast.show = false, 4000); },
                checkCompletion(mission, tlIndex, todo) { if (mission.title.includes("H·ªôp √Ω t∆∞·ªüng")) return; if (todo.startTime && todo.startTime.length >= 10) { const start = new Date(todo.startTime); const now = new Date(); const diffTime = Math.abs(now - start); const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)); if (diffDays > 3) { this.triggerConfetti(1, 'gold'); this.showToast(`B·∫°n ƒë√£ theo ƒëu·ªïi vi·ªác n√†y ${diffDays} ng√†y!`, '<i class="fas fa-mountain"></i>', "S·ª± ki√™n tr√¨ ƒë√°ng n·ªÉ"); return; } } const tasklist = mission.tasklists[tlIndex]; const allTodosDone = tasklist.todos.length > 0 && tasklist.todos.every(t => t.status === 'done' || t.status === 'cancel'); if (allTodosDone) { const allTasklistsDone = mission.tasklists.every(tl => tl.todos.length > 0 && tl.todos.every(t => t.status === 'done' || t.status === 'cancel')); if (allTasklistsDone) { this.triggerConfetti(2.5, 'regular'); this.celebrationMessage = "B·∫°n ƒë√£ chinh ph·ª•c ƒë∆∞·ª£c m·ª•c ti√™u l·ªõn!"; this.completedMissionTitle = mission.title; this.showCelebrationModal = true; } else { this.triggerConfetti(1.0, 'regular'); this.showToast(`ƒê√£ xong nh√≥m vi·ªác "${tasklist.title}"`, '<i class="fas fa-check-double"></i>', "Ho√†n th√†nh nh√≥m"); } } else { this.triggerConfetti(0.3, 'regular'); const praises = ["L√†m t·ªët l·∫Øm!", "Ti·∫øp t·ª•c nh√©!", "Xu·∫•t s·∫Øc!", "Qu√° d·ªØ!", "1 like cho b·∫°n!"]; this.showToast(praises[Math.floor(Math.random() * praises.length)], '<i class="fas fa-thumbs-up"></i>', "Xong 1 vi·ªác"); } },
                async saveEdit() { if (!this.editingTodo) return; const { mission, tlIndex, tIndex } = this.editingTodo; const oldStatus = mission.tasklists[tlIndex].todos[tIndex].status; const updatedTodo = { ...mission.tasklists[tlIndex].todos[tIndex], ...this.editForm }; mission.tasklists[tlIndex].todos[tIndex] = updatedTodo; await this.updateMission(mission); if (oldStatus !== 'done' && this.editForm.status === 'done') this.checkCompletion(mission, tlIndex, updatedTodo); if(!this.showQuickAddModal) this.closeEditModal(); },
                onMoveMissionChange() { this.moveTarget.tasklistId = ''; if (this.targetMission && this.targetMission.tasklists.length > 0) this.moveTarget.tasklistId = this.targetMission.tasklists[0].id; },
                async moveTodo() { if (!this.moveTarget.missionId || !this.moveTarget.tasklistId) return; const sourceMission = this.editingTodo.mission; const sourceTlIndex = this.editingTodo.tlIndex; const sourceTIndex = this.editingTodo.tIndex; const targetMission = this.missions.find(m => m.id === this.moveTarget.missionId); if (!targetMission) return; const targetTlIndex = targetMission.tasklists.findIndex(tl => tl.id === this.moveTarget.tasklistId); if (targetTlIndex === -1) return; const todoToMove = { ...sourceMission.tasklists[sourceTlIndex].todos[sourceTIndex] }; const isSourceIdea = sourceMission.title.includes("H·ªôp √Ω t∆∞·ªüng"); const isTargetIdea = targetMission.title.includes("H·ªôp √Ω t∆∞·ªüng"); if (isSourceIdea && !isTargetIdea) { todoToMove.status = 'doing'; if (!todoToMove.startTime) todoToMove.startTime = new Date().toISOString().slice(0, 10); } else if (!isSourceIdea && isTargetIdea) { todoToMove.status = 'idea'; } sourceMission.tasklists[sourceTlIndex].todos.splice(sourceTIndex, 1); if (sourceMission.id === targetMission.id) { sourceMission.tasklists[targetTlIndex].todos.push(todoToMove); await this.updateMission(sourceMission); } else { targetMission.tasklists[targetTlIndex].todos.push(todoToMove); await this.updateMission(sourceMission); await this.updateMission(targetMission); } this.showToast("ƒê√£ chuy·ªÉn th√†nh c√¥ng!", '<i class="fas fa-exchange-alt"></i>', "Th√†nh c√¥ng"); this.closeEditModal(); },
                async deleteEditingTodo() { if(!confirm("X√≥a?")) return; const { mission, tlIndex, tIndex } = this.editingTodo; mission.tasklists[tlIndex].todos.splice(tIndex, 1); await this.updateMission(mission); this.closeEditModal(); },
                addTasklist(mission, event) { if (!event.target.value.trim()) return; mission.tasklists.push({ id: this.generateId(), title: event.target.value, todos: [] }); this.updateMission(mission); event.target.value = ''; },
                deleteTasklist(mission, tlIndex) { if(confirm('X√≥a danh s√°ch?')) { mission.tasklists.splice(tlIndex, 1); this.updateMission(mission); } },
                
                exportData(type) {
                    this.showMenu = false;
                    const dataToExport = this.missions.map(m => {
                        const { id, userId, ...rest } = m;
                        return rest;
                    });
                    const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(dataToExport, null, 2));
                    const downloadAnchorNode = document.createElement('a');
                    downloadAnchorNode.setAttribute("href", dataStr);
                    const date = new Date().toISOString().slice(0,10);
                    downloadAnchorNode.setAttribute("download", `ZxBiz_Backup_${date}.json`);
                    document.body.appendChild(downloadAnchorNode);
                    downloadAnchorNode.click();
                    downloadAnchorNode.remove();
                    this.showToast("ƒê√£ t·∫£i file backup v·ªÅ m√°y!", '<i class="fas fa-download"></i>', "Sao l∆∞u th√†nh c√¥ng");
                }, 
                
                async importData(event) {
                    const file = event.target.files[0]; if (!file) return; const reader = new FileReader(); reader.onload = async (e) => { try { const content = e.target.result; const data = JSON.parse(content); if (!Array.isArray(data)) throw new Error("File JSON kh√¥ng h·ª£p l·ªá"); this.loading = true; this.showMenu = false; let count = 0; for (const m of data) {
                        const newMission = { title: m.title || "Untitled", createdAt: Date.now() + count, tasklists: m.tasklists || [] }; await addDoc(collection(db, "missions"), newMission); count++; } this.showToast(`ƒê√£ nh·∫≠p th√†nh c√¥ng ${count} m·ª•c ti√™u!`, '<i class="fas fa-file-import"></i>', "Import th√†nh c√¥ng"); } catch (err) { console.error(err); alert("L·ªói khi ƒë·ªçc file: " + err.message); } finally { this.loading = false; } }; reader.readAsText(file); event.target.value = ''; },
                filteredTodos(todos) { if (this.filterStatus === 'all') return todos; if (this.filterStatus === 'money') return todos.filter(t => t.money !== 0); if (this.filterStatus === 'loop') return todos.filter(t => t.isLoop); return todos.filter(t => t.status === this.filterStatus); }
            }
        }).mount('#app');
    </script>
</body>
</html>