<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ZxBiz F1.0 - Freelancer Pro</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#1D3E53">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    
    <style>
        /* T√¥ng m√†u ZxBiz: Navy (Chuy√™n nghi·ªáp) & Gold (Ti·ªÅn b·∫°c) */
        :root { --primary: #1D3E53; --secondary: #77A6B6; --accent: #E49B45; --bg: #EAF4F4; }
        body { background-color: var(--bg); color: var(--primary); -webkit-tap-highlight-color: transparent; }
        
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .loader { border: 3px solid #fff; border-top: 3px solid var(--accent); border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        [v-cloak] { display: none !important; }

        .board-container { display: flex; gap: 0.8rem; overflow-x: auto; scroll-snap-type: x mandatory; padding-bottom: 0.5rem; scroll-behavior: smooth; }
        .mission-card { min-width: 85vw; max-width: 85vw; scroll-snap-align: center; display: flex; flex-direction: column; max-height: 65vh; border-radius: 1rem; overflow: hidden; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); }
        @media (min-width: 768px) { .mission-card { min-width: 320px; max-width: 320px; } }
        .mission-body { overflow-y: auto; flex: 1; padding: 0.5rem; }

        /* Themes Biz */
        .theme-idea { border: 2px solid #E49B45; background-color: #FFF8E1; }
        .theme-normal .header { background-color: #1D3E53; color: white; }
        .theme-normal .body { background-color: #EAF4F4; }
        .idea-focus-container { max-height: 80px; overflow-y: auto; }

        /* STATUS STYLES (Focus v√†o tr·∫°ng th√°i ti·ªÅn/n·ª£) */
        .card-done { border-left: 4px solid #1D3E53; opacity: 0.6; background-color: #F0F9F9; }
        .card-cancel { border-left: 4px solid #9CA3AF; text-decoration: line-through; opacity: 0.5; }
        .card-loop { border-left: 4px solid #8B5CF6; background-color: #F5F3FF; }
        .card-debt { border-left: 4px solid #EF4444; background-color: #FEF2F2; border-right: 1px solid #EF4444; } /* Kh√°ch n·ª£ */
        .card-doing { border-left: 4px solid #77A6B6; }

        .toast-enter-active, .toast-leave-active { transition: all 0.5s ease; }
        .toast-enter-from, .toast-leave-to { opacity: 0; transform: translateY(-20px); }
    </style>
</head>
<body>
    
    <div id="app" v-cloak class="max-w-md mx-auto min-h-screen shadow-2xl flex flex-col relative transition-all duration-300 pb-20 bg-[#EAF4F4]">
        
        <transition name="toast">
            <div v-if="toast.show" class="fixed top-20 left-1/2 transform -translate-x-1/2 z-[150] bg-[#1D3E53] text-white px-6 py-4 rounded-xl shadow-2xl flex items-center border-2 border-[#E49B45] min-w-[300px]">
                <div class="mr-3 text-2xl" v-html="toast.icon"></div>
                <div><div class="font-bold text-sm text-[#E49B45] uppercase mb-1">{{ toast.title }}</div><div class="font-medium text-sm">{{ toast.message }}</div></div>
            </div>
        </transition>

        <div class="bg-[#1D3E53] text-white p-4 sticky top-0 z-50 shadow-lg flex justify-between items-center">
            <h1 class="font-bold text-lg flex items-center cursor-pointer" @click="scrollToTop">
                <i class="fas fa-rocket mr-2"></i>ZxBiz 
                <span v-if="isPlus" class="bg-gradient-to-r from-purple-500 to-pink-500 text-[10px] px-1.5 py-0.5 rounded ml-1 font-bold">PLUS</span>
                <span v-else class="bg-[#E49B45] text-black text-[10px] px-1.5 py-0.5 rounded ml-1 font-bold">FREE</span>
            </h1>
            <div class="relative">
                <button @click="showMenu = !showMenu" class="p-2 hover:bg-[#77A6B6] rounded transition"><i class="fas fa-ellipsis-v"></i></button>
                <div v-if="showMenu" class="absolute right-0 top-10 bg-white text-[#1D3E53] shadow-xl rounded w-56 py-2 border z-50">
                    <button @click="togglePlus" class="block w-full text-left px-4 py-2 hover:bg-[#BEE9E4]/30 font-bold" :class="isPlus ? 'text-gray-500' : 'text-purple-600'">
                        <i class="fas" :class="isPlus ? 'fa-toggle-off' : 'fa-crown'"></i> {{ isPlus ? 'V·ªÅ giao di·ªán g·ªçn (3 Tab)' : 'M·ªü r·ªông Studio (5 Tab)' }}
                    </button>
                    <button @click="resetBlocks" class="block w-full text-left px-4 py-2 hover:bg-[#BEE9E4]/30 text-red-500"><i class="fas fa-undo mr-2"></i>Reset C·∫•u tr√∫c</button>
                    <button @click="exportData('json')" class="block w-full text-left px-4 py-2 hover:bg-[#BEE9E4]/30"><i class="fas fa-file-code mr-2"></i>Backup JSON</button>
                    <label class="block w-full text-left px-4 py-2 hover:bg-[#BEE9E4]/30 cursor-pointer"><i class="fas fa-file-import mr-2"></i>Import File<input type="file" @change="importData" class="hidden" accept=".json"></label>
                </div>
            </div>
        </div>
        <div v-if="showMenu" @click="showMenu = false" class="fixed inset-0 z-40 bg-black bg-opacity-20"></div>

        <div class="p-4 bg-white border-b shadow-sm space-y-3">
            <div class="relative">
                <input v-model="quickInput" @keyup.enter="openQuickAddModal" placeholder="T√¨m ki·∫øm ho·∫∑c th√™m nhanh..." class="w-full pl-10 pr-12 py-3 border-2 border-[#1D3E53] rounded-xl bg-[#EAF4F4] focus:bg-white focus:outline-none text-[#1D3E53] font-medium shadow-sm transition-all">
                <i class="fas fa-search absolute left-3 top-3.5 text-[#1D3E53]"></i>
                <button @click="openQuickAddModal" class="absolute right-2 top-2 bg-[#1D3E53] text-white p-1.5 px-3 rounded-lg hover:bg-[#77A6B6]"><i class="fas fa-arrow-up"></i></button>
            </div>
            
            <div @click="showReportModal = true" class="flex gap-4 text-xs font-bold text-[#1D3E53]/70 justify-center cursor-pointer hover:bg-gray-50 p-2 rounded-lg transition border border-transparent hover:border-gray-200">
                <span class="flex items-center"><i class="fas fa-arrow-down text-[#77A6B6] mr-1"></i> {{ formatMoney(stats.income) }}</span>
                <span class="flex items-center"><i class="fas fa-arrow-up text-[#E49B45] mr-1"></i> {{ formatMoney(stats.expense) }}</span>
                <span class="ml-2 text-[#1D3E53] opacity-50"><i class="fas fa-chart-pie"></i> Xem b√°o c√°o</span>
            </div>
        </div>

        <div class="flex-1 flex flex-col bg-[#EAF4F4] overflow-hidden space-y-4 overflow-y-auto pb-10">
            <div v-if="loading" class="text-center py-10"><div class="loader mx-auto mb-2"></div></div>
            <div v-else>
                
                <div v-if="ideaMission" class="px-3 mt-3">
                    <div class="w-full bg-[#FFF8E1] border-2 border-[#E49B45] rounded-xl shadow-sm overflow-hidden flex flex-col">
                        <div class="bg-[#FFF3CD] px-3 py-2 flex justify-between items-center border-b border-[#E49B45]/30">
                            <span class="text-xs font-bold text-[#E49B45] uppercase tracking-wider flex items-center"><i class="fas fa-lightbulb mr-1"></i> MARKET IDEAS</span>
                            <span class="text-[10px] text-[#E49B45]/70">{{ ideaMission.tasklists[0]?.todos.length || 0 }} √Ω t∆∞·ªüng</span>
                        </div>
                        <div class="p-2">
                            <div class="mb-2"><input @keyup.enter="addIdeaDirectly(ideaMission, $event)" placeholder="üí° √ù t∆∞·ªüng ki·∫øm ti·ªÅn m·ªõi..." class="w-full text-sm p-2 bg-white border border-[#E49B45]/30 rounded-lg focus:outline-none focus:ring-2 focus:ring-[#E49B45] text-[#1D3E53] placeholder-[#E49B45]/50 shadow-inner"></div>
                            <div class="idea-focus-container space-y-2 pr-1 custom-scrollbar">
                                <template v-if="ideaMission.tasklists.length > 0 && ideaMission.tasklists[0].todos.length > 0">
                                    <div v-for="(todo, tIndex) in ideaMission.tasklists[0].todos.slice().reverse()" :key="todo.id" class="p-2 bg-white rounded border border-[#E49B45]/10 flex justify-between items-center cursor-pointer hover:bg-[#FFF3CD] transition group" @click="openEditModal(ideaMission, 0, (ideaMission.tasklists[0].todos.length - 1 - tIndex), true)">
                                        <span class="text-sm font-medium text-[#1D3E53] truncate flex-1">{{ todo.content }}</span><i class="fas fa-pen text-[10px] text-[#E49B45] opacity-0 group-hover:opacity-100"></i>
                                    </div>
                                </template>
                                <div v-else class="text-center text-xs text-[#E49B45]/40 italic py-1">Tr·ªëng tr∆°n... H√£y l·∫•p ƒë·∫ßy b·∫±ng c∆° h·ªôi!</div>
                            </div>
                        </div>
                    </div>
                </div>

                <div v-for="blockIndex in (unlockedBlocks + 1)" :key="blockIndex" class="relative mt-2">
                    <div v-if="blockIndex <= unlockedBlocks">
                        <div class="flex justify-between items-center px-4 mb-2 group">
                            <div class="flex items-center">
                                <h3 class="text-xs font-bold uppercase text-[#1D3E53] tracking-wider flex items-center cursor-pointer" @click="editBlockName(blockIndex)">
                                    <span class="text-white text-[10px] px-2 py-0.5 rounded mr-2 transition-all shadow" :class="isPlus ? 'bg-gradient-to-r from-purple-500 to-pink-500' : 'bg-[#1D3E53]'">{{ getBlockName(blockIndex) }}</span><i class="fas fa-pencil-alt text-[10px] text-gray-400 opacity-0 group-hover:opacity-100 transition"></i>
                                </h3>
                                <span class="text-gray-400 text-[10px] ml-2 font-mono">{{ getBlockStatus(blockIndex) }}</span>
                            </div>
                            <button v-if="canAddMissionToBlock(blockIndex)" @click="promptAddMission(blockIndex)" class="text-xs bg-[#77A6B6] text-white px-2 py-1 rounded hover:bg-[#1D3E53] shadow"><i class="fas fa-plus mr-1"></i>Th√™m</button>
                        </div>
                        <div class="board-container no-scrollbar pl-3 pr-3" :id="'block-' + blockIndex">
                            <div v-for="mission in getMissionsForBlock(blockIndex)" :key="mission.id" class="mission-card border shrink-0 theme-normal border-[#1D3E53]/10">
                                
                                <div class="p-3 header flex justify-between items-center sticky top-0 z-10">
                                    <h2 class="font-bold text-sm truncate uppercase max-w-[70%]"><i class="fas fa-flag mr-1"></i> {{ mission.title }}</h2>
                                    <div class="flex gap-1 opacity-70 hover:opacity-100"><button @click="editMissionTitle(mission)" class="px-1"><i class="fas fa-pen text-xs"></i></button><button @click="deleteMission(mission.id)" class="px-1"><i class="fas fa-trash text-xs"></i></button></div>
                                </div>
                                
                                <div class="px-3 py-1.5 bg-gray-50 border-b border-gray-100 flex justify-between items-center text-[10px] font-bold font-mono">
                                    <div class="flex items-center text-[#1D3E53] tooltip" title="T·ªïng thu"><i class="fas fa-arrow-down text-[#77A6B6] mr-1"></i> {{ formatMoney(getMissionStats(mission).income) }}</div>
                                    <div class="flex items-center text-[#1D3E53] tooltip" title="T·ªïng chi"><i class="fas fa-arrow-up text-[#E49B45] mr-1"></i> {{ formatMoney(getMissionStats(mission).expense) }}</div>
                                    <div class="flex items-center tooltip" title="L·ª£i nhu·∫≠n r√≤ng" :class="getMissionStats(mission).profit >= 0 ? 'text-green-600' : 'text-red-500'"><span class="mr-1">=</span> {{ formatMoney(getMissionStats(mission).profit) }}</div>
                                </div>

                                <div class="p-2 bg-[#F0F9F9] border-b border-[#1D3E53]/5"><input @keyup.enter="addTasklist(mission, $event)" placeholder="+ Th√™m nh√≥m vi·ªác..." class="w-full text-xs p-2 rounded bg-white border border-[#1D3E53]/10 focus:border-[#1D3E53] outline-none"></div>
                                
                                <div class="mission-body body space-y-3">
                                    <div v-for="(tl, tlIndex) in mission.tasklists" :key="tl.id" class="mb-3">
                                        <div class="flex justify-between items-center mb-1">
                                            <h4 class="font-bold text-xs text-[#1D3E53] uppercase">{{ tl.title }}</h4>
                                            <div class="flex">
                                                <button @click="createQuote(tl)" class="text-[#77A6B6] hover:text-[#1D3E53] px-2" title="T·∫°o b√°o gi√°/Bill"><i class="fas fa-file-invoice-dollar text-xs"></i></button>
                                                <button @click="editTasklistTitle(mission, tlIndex)" class="text-gray-400 hover:text-[#1D3E53] px-1"><i class="fas fa-pen text-[10px]"></i></button>
                                                <button @click="deleteTasklist(mission, tlIndex)" class="text-gray-400 hover:text-[#E49B45] px-1"><i class="fas fa-times text-[10px]"></i></button>
                                            </div>
                                        </div>
                                        <input @keyup.enter="addTodoDirectly(mission, tlIndex, $event)" placeholder="+ Vi·ªác nh·ªè..." class="w-full text-xs p-1.5 mb-2 rounded border border-gray-200 bg-white/50 focus:bg-white outline-none">
                                        <div class="space-y-1.5">
                                            <div v-for="(todo, tIndex) in filteredTodos(tl.todos)" :key="todo.id" class="bg-white p-2 rounded shadow-sm text-sm cursor-pointer border-l-4" 
                                                :class="[
                                                    todo.isLoop ? 'card-loop' : '',
                                                    todo.status === 'done' ? 'card-done' : '',
                                                    todo.status === 'cancel' ? 'card-cancel' : '',
                                                    todo.status === 'debt' ? 'card-debt' : '',
                                                    todo.status === 'doing' ? 'card-doing' : ''
                                                ]" 
                                                @click="openEditModal(mission, tlIndex, tIndex, false)">
                                                <div class="flex justify-between items-center">
                                                    <span class="truncate flex-1 mr-2">{{ todo.content }}</span>
                                                    <div class="flex items-center shrink-0">
                                                        <button v-if="todo.money != 0" @click.stop="createSingleQuote(todo)" class="text-gray-400 hover:text-[#1D3E53] mr-2 px-1" title="Ch·ªët gi√° m√≥n n√†y"><i class="fas fa-receipt text-xs"></i></button>
                                                        
                                                        <span v-if="todo.money" :class="todo.money > 0 ? 'text-[#1D3E53]' : 'text-[#E49B45]'" class="text-[10px] font-bold">{{ formatMoney(todo.money) }}</span>
                                                        
                                                        <button v-if="todo.status === 'debt'" @click.stop="copyDebtReminder(todo)" class="ml-2 text-red-500 hover:text-red-700 animate-pulse" title="Copy tin nh·∫Øc n·ª£"><i class="fas fa-bell text-xs"></i></button>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div v-if="mission.tasklists.length === 0" class="text-center text-xs text-gray-400 italic py-4">Ch∆∞a c√≥ nh√≥m vi·ªác</div>
                                </div>
                            </div>
                            <div v-if="getMissionsForBlock(blockIndex).length === 0" class="mission-card border-2 border-dashed border-gray-300 rounded-xl flex flex-col items-center justify-center text-gray-400 text-sm bg-white/50 min-h-[200px]"><i class="fas fa-wind text-2xl mb-2"></i><span>Block tr·ªëng</span><button @click="promptAddMission(blockIndex)" class="mt-2 text-[#1D3E53] underline font-bold">Th√™m Mission</button></div>
                        </div>
                    </div>
                    <div v-else class="mt-4 border-t-2 border-dashed border-[#E49B45]/30 pt-4 px-2 mx-2"><div class="bg-white rounded-xl shadow-lg border-2 border-[#E49B45] p-6 text-center relative overflow-hidden"><div class="absolute top-0 right-0 bg-[#E49B45] text-white text-[10px] font-bold px-2 py-1 rounded-bl">STORE</div><i class="fas fa-lock text-4xl text-[#1D3E53] mb-3"></i><h3 class="text-lg font-bold text-[#1D3E53] uppercase">M·ªü kh√≥a Block {{ blockIndex }}</h3><button @click="unlockNextBlock" class="w-full bg-[#E49B45] text-white py-3 rounded-lg font-bold shadow mt-2 hover:bg-[#d88d3a]">Mua ngay (Demo)</button></div></div>
                </div>
            </div>
        </div>

        <div v-if="showReportModal" class="fixed inset-0 z-[120] flex items-center justify-center bg-black bg-opacity-80 p-4 backdrop-blur-sm" @click="showReportModal = false">
            <div class="bg-white rounded-xl shadow-2xl w-full max-w-md overflow-hidden animate-fade-in flex flex-col max-h-[90vh]" @click.stop>
                <div class="bg-[#1D3E53] p-4 text-white font-bold flex justify-between items-center sticky top-0 z-10"><span class="text-lg"><i class="fas fa-chart-pie mr-2"></i> B√°o c√°o Thu Chi</span><button @click="showReportModal = false" class="text-white/80 hover:text-white"><i class="fas fa-times"></i></button></div>
                <div class="overflow-y-auto p-4 space-y-4">
                    <div class="bg-[#EAF4F4] p-4 rounded-xl border border-[#1D3E53]/10 text-center">
                        <div class="text-xs text-[#1D3E53] font-bold uppercase mb-2">L·ª£i nhu·∫≠n r√≤ng (Net Profit)</div>
                        <div class="text-3xl font-black" :class="(stats.income - stats.expense) >= 0 ? 'text-[#1D3E53]' : 'text-[#E49B45]'">{{ formatMoney(stats.income - stats.expense) }}</div>
                        <div class="flex justify-between mt-4 text-sm px-4">
                            <div class="text-[#77A6B6] font-bold"><i class="fas fa-arrow-down"></i> {{ formatMoney(stats.income) }}</div>
                            <div class="text-[#E49B45] font-bold"><i class="fas fa-arrow-up"></i> {{ formatMoney(stats.expense) }}</div>
                        </div>
                    </div>
                    <div class="text-xs font-bold text-[#1D3E53] uppercase border-b pb-1 mt-2">Chi ti·∫øt theo Mission</div>
                    <div v-if="missionReports.length > 0" class="space-y-3">
                        <div v-for="report in missionReports" :key="report.title" class="bg-white border border-gray-200 rounded-lg p-3 shadow-sm">
                            <div class="flex justify-between items-center mb-2"><div class="font-bold text-[#1D3E53] text-sm truncate max-w-[60%]">{{ report.title }}</div><div class="font-bold text-sm" :class="report.profit >= 0 ? 'text-[#1D3E53]' : 'text-[#E49B45]'">{{ report.profit > 0 ? '+' : '' }}{{ formatMoney(report.profit) }}</div></div>
                            <div class="h-1.5 w-full bg-gray-100 rounded-full overflow-hidden flex mb-2"><div v-if="report.income > 0" class="h-full bg-[#77A6B6]" :style="{ width: (report.income / (report.income + report.expense || 1) * 100) + '%' }"></div><div v-if="report.expense > 0" class="h-full bg-[#E49B45]" :style="{ width: (report.expense / (report.income + report.expense || 1) * 100) + '%' }"></div></div>
                            <div class="flex justify-between text-[10px] text-gray-500 font-mono"><span>Thu: {{ formatMoney(report.income) }}</span><span>Chi: {{ formatMoney(report.expense) }}</span></div>
                        </div>
                    </div>
                    <div v-else class="text-center text-gray-400 text-sm py-4">Ch∆∞a c√≥ d·ªØ li·ªáu t√†i ch√≠nh</div>
                </div>
            </div>
        </div>

        <div v-if="editingTodo" class="fixed inset-0 z-[60] flex items-center justify-center bg-black bg-opacity-70 p-4 backdrop-blur-sm"><div class="bg-[#BEE9E4] rounded-xl shadow-2xl w-full max-w-sm overflow-hidden animate-fade-in border-2 border-[#1D3E53] flex flex-col max-h-[95vh]"><div class="bg-[#1D3E53] p-3 text-white font-bold flex justify-between items-center shrink-0"><span><i class="fas" :class="editingTodo.isIdea ? 'fa-lightbulb' : 'fa-edit'"></i> Chi ti·∫øt</span><button @click="closeEditModal" class="text-white/80 hover:text-white"><i class="fas fa-times"></i></button></div><div class="p-5 space-y-4 overflow-y-auto"><div><label class="block text-xs font-bold text-[#1D3E53] uppercase mb-1">N·ªôi dung</label><input v-model="editForm.content" class="w-full p-3 border border-[#1D3E53]/20 rounded-lg bg-white text-[#1D3E53] focus:ring-2 ring-[#1D3E53] outline-none font-bold text-lg"></div><template v-if="!editingTodo.isIdea"><div class="flex items-center justify-between bg-white p-3 rounded-lg border border-[#8B5CF6]/30"><span class="text-sm font-bold text-[#1D3E53] flex items-center"><i class="fas fa-sync-alt text-[#8B5CF6] mr-2"></i> L·∫∑p l·∫°i?</span><label class="relative inline-flex items-center cursor-pointer"><input type="checkbox" v-model="editForm.isLoop" class="sr-only peer"><div class="w-11 h-6 bg-gray-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-[#8B5CF6]"></div></label></div><div v-if="editForm.isLoop" class="bg-[#F5F3FF] p-3 rounded-lg border border-[#8B5CF6]/30"><button @click="checkInLoop" class="w-full bg-[#8B5CF6] text-white py-2 rounded-lg font-bold shadow hover:bg-[#7C3AED] mb-3 transition"><i class="fas fa-check-circle mr-2"></i>Ghi nh·∫≠n h√¥m nay</button><div class="max-h-24 overflow-y-auto text-xs space-y-1"><div v-for="(log, idx) in (editForm.logs || []).slice().reverse()" :key="idx" class="text-[#1D3E53] flex justify-between border-b border-[#8B5CF6]/10 pb-1"><span>{{ formatDateFull(log) }}</span><span class="text-[#8B5CF6]"><i class="fas fa-check"></i></span></div></div></div><div class="flex gap-3" v-if="!editForm.isLoop"><div class="flex-1"><label class="block text-xs font-bold text-[#1D3E53] uppercase mb-1">Ti·ªÅn</label><input type="number" v-model.number="editForm.money" placeholder="0" class="w-full p-2 border border-[#1D3E53]/20 rounded-lg bg-white text-[#1D3E53] font-mono font-bold"></div><div class="flex-1"><label class="block text-xs font-bold text-[#1D3E53] uppercase mb-1">Tr·∫°ng th√°i</label><select v-model="editForm.status" class="w-full p-2 border border-[#1D3E53]/20 rounded-lg bg-white text-[#1D3E53]"><option value="doing">ƒêang l√†m</option><option value="done">Ho√†n th√†nh</option><option value="debt" class="text-red-500 font-bold">‚ùó Kh√°ch n·ª£</option><option value="pause">T·∫°m d·ª´ng</option><option value="cancel">ƒê√£ h·ªßy</option></select></div></div><div class="flex gap-3"><div class="flex-1"><label class="block text-xs font-bold text-[#1D3E53] uppercase mb-1">B·∫Øt ƒë·∫ßu</label><input type="date" v-model="editForm.startTime" class="w-full p-2 border border-[#1D3E53]/20 rounded-lg bg-white text-[#1D3E53]"></div><div class="flex-1"><label class="block text-xs font-bold text-[#1D3E53] uppercase mb-1">K·∫øt th√∫c</label><input type="date" v-model="editForm.endTime" class="w-full p-2 border border-[#1D3E53]/20 rounded-lg bg-white text-[#1D3E53]"></div></div></template><div><label class="block text-xs font-bold text-[#1D3E53] uppercase mb-1">Ghi ch√∫</label><textarea v-model="editForm.note" rows="3" class="w-full p-2 border border-[#1D3E53]/20 rounded-lg bg-white text-[#1D3E53] text-sm"></textarea></div><div class="flex gap-2 pt-2"><button @click="deleteEditingTodo" class="flex-1 bg-[#E49B45]/20 text-[#E49B45] py-3 rounded-lg font-bold hover:bg-[#E49B45]/30 transition"><i class="fas fa-trash"></i></button><button @click="saveEdit" class="flex-2 w-full bg-[#1D3E53] text-white py-3 rounded-lg font-bold shadow-lg hover:bg-[#77A6B6] transition transform active:scale-95"><i class="fas fa-save mr-1"></i> L∆∞u l·∫°i</button></div><hr class="border-[#1D3E53]/20 my-2"><div class="bg-white/50 p-3 rounded-lg border border-[#1D3E53]/10"><div class="text-xs font-bold text-[#1D3E53] uppercase mb-2"><i class="fas fa-exchange-alt mr-1"></i> Di chuy·ªÉn</div><div class="space-y-2"><select v-model="moveTarget.missionId" @change="onMoveMissionChange" class="w-full p-2 text-sm border border-[#1D3E53]/20 rounded bg-white"><option value="" disabled>Ch·ªçn Mission...</option><option v-for="m in normalMissions" :key="m.id" :value="m.id">{{ m.title }}</option></select><select v-if="moveTarget.missionId" v-model="moveTarget.tasklistId" class="w-full p-2 text-sm border border-[#1D3E53]/20 rounded bg-white"><option value="" disabled>Ch·ªçn Nh√≥m vi·ªác...</option><option v-for="tl in targetTasklists" :key="tl.id" :value="tl.id">{{ tl.title }}</option></select><button v-if="moveTarget.tasklistId" @click="moveTodo" class="w-full bg-[#77A6B6] text-white py-2 rounded text-sm font-bold hover:bg-[#1D3E53] transition shadow">Chuy·ªÉn ngay</button></div></div></div></div></div>
        <div v-if="showQuickAddModal" class="fixed inset-0 z-[100] flex items-center justify-center bg-black bg-opacity-80 p-4 backdrop-blur-sm"><div class="bg-[#BEE9E4] rounded-xl shadow-2xl w-full max-w-sm overflow-hidden animate-fade-in border-2 border-[#1D3E53]"><div class="bg-[#1D3E53] p-3 text-white font-bold flex justify-between items-center"><span><i class="fas fa-plus-circle"></i> Th√™m nhanh</span><button @click="showQuickAddModal = false" class="text-white/80 hover:text-white"><i class="fas fa-times"></i></button></div><div class="p-5 space-y-4"><div><label class="block text-xs font-bold text-[#1D3E53] uppercase mb-1">N·ªôi dung</label><input v-model="quickAddForm.content" class="w-full p-3 border border-[#1D3E53]/20 rounded-lg bg-white text-[#1D3E53] focus:ring-2 ring-[#1D3E53] outline-none font-bold text-lg"></div><div><label class="block text-xs font-bold text-[#1D3E53] uppercase mb-1">Ch·ªçn M·ª•c ti√™u</label><select v-model="quickAddForm.missionId" @change="onMissionChange" class="w-full p-3 border border-[#1D3E53]/20 rounded-lg bg-white text-[#1D3E53] font-medium"><option v-for="m in normalMissions" :key="m.id" :value="m.id">{{ m.title }}</option></select></div><div v-if="selectedMissionHasTasklists"><label class="block text-xs font-bold text-[#1D3E53] uppercase mb-1">Ch·ªçn Nh√≥m vi·ªác</label><select v-model="quickAddForm.tasklistId" class="w-full p-3 border border-[#1D3E53]/20 rounded-lg bg-white text-[#1D3E53]"><option v-for="tl in availableTasklists" :key="tl.id" :value="tl.id">{{ tl.title }}</option></select></div><div class="pt-2"><button @click="saveQuickAdd" class="w-full bg-[#1D3E53] text-white py-3 rounded-lg font-bold shadow-lg hover:bg-[#77A6B6] transition transform active:scale-95"><i class="fas fa-check mr-2"></i>T·∫°o & Nh·∫≠p chi ti·∫øt</button></div></div></div></div>
        <div v-if="showCelebrationModal" class="fixed inset-0 z-[110] flex items-center justify-center bg-black bg-opacity-90 p-4 animate-fade-in" @click="showCelebrationModal = false"><div class="bg-gradient-to-br from-[#1D3E53] to-[#77A6B6] rounded-2xl shadow-2xl w-full max-w-sm text-center p-8 border-4 border-[#E49B45] relative overflow-hidden" @click.stop><div class="absolute inset-0 bg-white/10"></div><i class="fas fa-trophy text-6xl text-yellow-300 mb-4 animate-bounce relative z-10"></i><h2 class="text-3xl font-bold text-white mb-2 relative z-10">TUY·ªÜT V·ªúI!</h2><p class="text-white/90 text-lg mb-6 relative z-10" v-text="celebrationMessage"></p><div class="bg-white/20 rounded-lg p-4 mb-6 relative z-10"><p class="text-sm text-white/80 uppercase tracking-widest">ƒê√£ ho√†n th√†nh</p><p class="text-xl font-bold text-white mt-1" v-text="completedMissionTitle"></p></div><button @click="showCelebrationModal = false" class="bg-[#E49B45] text-white px-8 py-3 rounded-full font-bold shadow-lg hover:bg-yellow-500 transition transform hover:scale-105 relative z-10">Ti·∫øp t·ª•c chi·∫øn!</button></div></div>
    </div>

    <script type="module">
        import { createApp } from 'https://unpkg.com/vue@3/dist/vue.esm-browser.js';
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js';
        import { getFirestore, collection, addDoc, onSnapshot, doc, updateDoc, deleteDoc, query, orderBy } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js';

        const firebaseConfig = { apiKey: "AIzaSyDFFeWWNoL3jZrv9FqLwnnbXv8p8eRyF5g", authDomain: "zxtodo-39f87.firebaseapp.com", projectId: "zxtodo-39f87", storageBucket: "zxtodo-39f87.firebasestorage.app", messagingSenderId: "1020484648812", appId: "1:1020484648812:web:83cadd3c7943d87472bd49" };
        const app = initializeApp(firebaseConfig); const db = getFirestore(app);

        createApp({
            data() {
                return {
                    showMenu: false, newMissionTitle: '', quickInput: '', filterStatus: 'all', missions: [], loading: true, editingTodo: null,
                    editForm: { content: '', money: 0, status: 'doing', note: '', startTime: '', endTime: '', isLoop: false, logs: [] },
                    showQuickAddModal: false, quickAddForm: { content: '', missionId: '', tasklistId: '' },
                    toast: { show: false, message: '', icon: '', title: '' }, showCelebrationModal: false, celebrationMessage: '', completedMissionTitle: '',
                    moveTarget: { missionId: '', tasklistId: '' },
                    unlockedBlocks: 1, isPlus: false, blockNames: {}, showReportModal: false,
                }
            },
            computed: {
                ideaMission() { return this.missions.find(m => m.title.includes("H·ªôp √Ω t∆∞·ªüng")) || null; },
                normalMissions() { return this.missions.filter(m => !m.title.includes("H·ªôp √Ω t∆∞·ªüng")); },
                missionsPerBlock() { return this.isPlus ? 5 : 3; },
                maxCapacity() { return this.unlockedBlocks * this.missionsPerBlock; },
                stats() { let income = 0, expense = 0; this.missions.forEach(m => { if(m.title.includes('H·ªôp √Ω t∆∞·ªüng')) return; m.tasklists.forEach(tl => tl.todos.forEach(t => { if(t.money > 0) income += t.money; if(t.money < 0) expense += Math.abs(t.money); })); }); return { income, expense }; },
                missionReports() { return this.normalMissions.map(m => { let inc = 0, exp = 0; m.tasklists.forEach(tl => tl.todos.forEach(t => { if(t.money > 0) inc += t.money; if(t.money < 0) exp += Math.abs(t.money); })); return { title: m.title, income: inc, expense: exp, profit: inc - exp }; }).sort((a,b) => b.profit - a.profit); },
                selectedMission() { return this.missions.find(m => m.id === this.quickAddForm.missionId); },
                selectedMissionHasTasklists() { return this.selectedMission && this.selectedMission.tasklists && this.selectedMission.tasklists.length > 0; },
                availableTasklists() { return this.selectedMission ? this.selectedMission.tasklists : []; },
                targetMission() { return this.missions.find(m => m.id === this.moveTarget.missionId); },
                targetTasklists() { return this.targetMission ? this.targetMission.tasklists : []; }
            },
            mounted() {
                if(localStorage.getItem('zx_unlocked_blocks')) this.unlockedBlocks = parseInt(localStorage.getItem('zx_unlocked_blocks'));
                if(localStorage.getItem('zx_is_plus')) this.isPlus = localStorage.getItem('zx_is_plus') === 'true';
                if(localStorage.getItem('zx_block_names')) this.blockNames = JSON.parse(localStorage.getItem('zx_block_names'));
                const q = query(collection(db, "missions"), orderBy("createdAt", "desc"));
                onSnapshot(q, (snapshot) => { let list = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })); this.missions = list; if(!list.find(m => m.title.includes("H·ªôp √Ω t∆∞·ªüng"))) { addDoc(collection(db, "missions"), { title: "H·ªôp √Ω t∆∞·ªüng", tasklists: [{id: 'tldefault', title: '√ù t∆∞·ªüng', todos:[]}], createdAt: Date.now() }); } this.loading = false; });
                window.addEventListener('keydown', this.handleKeyNav);
            },
            unmounted() { window.removeEventListener('keydown', this.handleKeyNav); },
            methods: {
                handleKeyNav(e) { const active = document.activeElement; if (active && (active.tagName === 'INPUT' || active.tagName === 'TEXTAREA' || active.isContentEditable)) return; if (this.showQuickAddModal || this.editingTodo || this.showCelebrationModal || this.showReportModal) return; if (e.key === 'ArrowRight' || e.key === 'ArrowLeft') { e.preventDefault(); const direction = e.key === 'ArrowRight' ? 1 : -1; const scrollAmount = 340 * direction; document.querySelectorAll('.board-container').forEach(container => container.scrollBy({ left: scrollAmount, behavior: 'smooth' })); } },
                generateId() { return Date.now().toString(36) + Math.random().toString(36).substr(2); },
                formatMoney(value) { return new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format(value); },
                formatDateSimple(dateStr) { if(!dateStr) return ''; const d = new Date(dateStr); return `${d.getDate()}/${d.getMonth()+1}`; },
                formatDateFull(dateStr) { if(!dateStr) return ''; const d = new Date(dateStr); return `${d.getDate()}/${d.getMonth()+1} ${d.getHours()}:${d.getMinutes()}`; },
                scrollToTop() { window.scrollTo({ top: 0, behavior: 'smooth' }); },
                getMissionsForBlock(blockIndex) { const start = (blockIndex - 1) * this.missionsPerBlock; return this.normalMissions.slice(start, start + this.missionsPerBlock); },
                canAddMissionToBlock(blockIndex) { return this.getMissionsForBlock(blockIndex).length < this.missionsPerBlock; },
                getBlockStatus(blockIndex) { return `${this.getMissionsForBlock(blockIndex).length}/${this.missionsPerBlock}`; },
                getBlockName(index) { return this.blockNames[index] || `BLOCK ${index}`; },
                editBlockName(index) { const current = this.blockNames[index] || `BLOCK ${index}`; const newName = prompt("ƒê·∫∑t t√™n cho Block n√†y:", current); if(newName && newName.trim()) { this.blockNames[index] = newName.trim(); localStorage.setItem('zx_block_names', JSON.stringify(this.blockNames)); } },
                togglePlus() { this.isPlus = !this.isPlus; localStorage.setItem('zx_is_plus', this.isPlus); this.showMenu = false; this.showToast(this.isPlus ? "ƒê√£ n√¢ng c·∫•p l√™n g√≥i Plus (5 tab)" : "ƒê√£ v·ªÅ g√≥i C∆° b·∫£n (3 tab)", '<i class="fas fa-exchange-alt"></i>', "Chuy·ªÉn ƒë·ªïi"); if(this.isPlus) this.triggerConfetti(1, 'gold'); },
                promptAddMission(blockIndex) { const t = prompt(`Nh·∫≠p t√™n Mission m·ªõi cho ${this.getBlockName(blockIndex)}:`); if(t) this.addMission(t); },
                unlockNextBlock() { this.unlockedBlocks++; localStorage.setItem('zx_unlocked_blocks', this.unlockedBlocks); this.triggerConfetti(2, 'gold'); this.showToast(`ƒê√£ m·ªü kh√≥a Block ${this.unlockedBlocks}!`, '<i class="fas fa-lock-open"></i>', "Th√†nh c√¥ng"); },
                resetBlocks() { this.unlockedBlocks = 1; localStorage.setItem('zx_unlocked_blocks', 1); localStorage.removeItem('zx_block_names'); this.blockNames={}; this.showMenu = false; alert("ƒê√£ reset"); },
                
                getMissionStats(mission) {
                    let income = 0, expense = 0;
                    if (mission.tasklists) { mission.tasklists.forEach(tl => { if (tl.todos) { tl.todos.forEach(t => { if (t.money > 0) income += t.money; if (t.money < 0) expense += Math.abs(t.money); }); } }); }
                    return { income, expense, profit: income - expense };
                },

                createQuote(tasklist) {
                    if (!tasklist || !tasklist.todos) return;
                    let text = `üìã B√ÅO GI√Å: ${tasklist.title.toUpperCase()}\n----------------\n`;
                    let total = 0; let hasItems = false;
                    tasklist.todos.forEach((t, idx) => { if (t.status !== 'cancel' && t.money > 0) { text += `${idx + 1}. ${t.content}: ${this.formatMoney(t.money)}\n`; total += t.money; hasItems = true; } });
                    if (!hasItems) { alert("Ch∆∞a c√≥ c√¥ng vi·ªác n√†o c√≥ ph√≠!"); return; }
                    text += `----------------\nüí∞ T·ªîNG C·ªòNG: ${this.formatMoney(total)}`;
                    navigator.clipboard.writeText(text).then(() => { this.showToast("ƒê√£ copy b√°o gi√°!", '<i class="fas fa-file-invoice-dollar"></i>', "S·∫µn s√†ng g·ª≠i"); });
                },

                createSingleQuote(todo) {
                    const text = `üõí D·ªäCH V·ª§: ${todo.content}\nüí∞ GI√Å: ${this.formatMoney(todo.money)}`;
                    navigator.clipboard.writeText(text).then(() => { this.showToast("ƒê√£ ch·ªët gi√° m√≥n n√†y!", '<i class="fas fa-receipt"></i>', "Copy th√†nh c√¥ng"); });
                },

                copyDebtReminder(todo) {
                    const text = `üëã Ch√†o b·∫°n,\nM√¨nh xin ph√©p nh·∫Øc l·∫°i kho·∫£n thanh to√°n cho vi·ªác: "${todo.content}".\nS·ªë ti·ªÅn: ${this.formatMoney(todo.money)}.\nB·∫°n xem v√† chuy·ªÉn kho·∫£n s·ªõm gi√∫p m√¨nh nh√©! C·∫£m ∆°n b·∫°n.`;
                    navigator.clipboard.writeText(text).then(() => { this.showToast("ƒê√£ copy tin nh·∫Øc n·ª£!", '<i class="fas fa-bell"></i>', "Nh·∫Øc nh·∫π nh√†ng"); });
                },

                async addMission(title = null) { if (this.normalMissions.length >= this.maxCapacity) { alert(`ƒê√£ h·∫øt ch·ªó tr·ªëng!`); return; } const finalTitle = typeof title === 'string' ? title : this.newMissionTitle; if (!finalTitle || !finalTitle.trim()) return; await addDoc(collection(db, "missions"), { title: finalTitle, tasklists: [], createdAt: Date.now() }); this.newMissionTitle = ''; },
                async updateMission(mission) { const { id, ...data } = mission; await updateDoc(doc(db, "missions", id), data); },
                async deleteMission(id) { if(confirm('X√≥a Mission?')) await deleteDoc(doc(db, "missions", id)); },
                async editMissionTitle(mission) { const t = prompt("T√™n m·ªõi:", mission.title); if(t) { mission.title = t; await this.updateMission(mission); } },
                async editTasklistTitle(mission, tlIndex) { const t = prompt("T√™n nh√≥m m·ªõi:", mission.tasklists[tlIndex].title); if(t) { mission.tasklists[tlIndex].title = t; await this.updateMission(mission); } },
                openQuickAddModal() { if (!this.quickInput.trim()) return; let defaultMissionId = ''; if (this.normalMissions.length > 0) defaultMissionId = this.normalMissions[0].id; this.quickAddForm = { content: this.quickInput, missionId: defaultMissionId, tasklistId: '' }; this.updateTasklistSelection(); this.showQuickAddModal = true; },
                onMissionChange() { this.updateTasklistSelection(); },
                updateTasklistSelection() { if (this.selectedMission && this.selectedMission.tasklists.length > 0) this.quickAddForm.tasklistId = this.selectedMission.tasklists[0].id; else this.quickAddForm.tasklistId = ''; },
                async saveQuickAdd() { const form = this.quickAddForm; const mission = this.missions.find(m => m.id === form.missionId); if (!mission) return; const isIdeaBox = mission.title.includes("H·ªôp √Ω t∆∞·ªüng"); const status = isIdeaBox ? 'idea' : 'doing'; const newItem = { id: this.generateId(), content: form.content, money: 0, status: status, note: '', startTime: isIdeaBox ? '' : new Date().toISOString().slice(0, 10), endTime: '', isLoop: false, logs: [] }; let targetTlIndex = 0; if (mission.tasklists.length === 0) mission.tasklists.push({ id: this.generateId(), title: isIdeaBox ? "√ù t∆∞·ªüng" : "Chung", todos: [] }); else if (form.tasklistId) { const idx = mission.tasklists.findIndex(tl => tl.id === form.tasklistId); if(idx !== -1) targetTlIndex = idx; } mission.tasklists[targetTlIndex].todos.push(newItem); await this.updateMission(mission); this.quickInput = ''; this.showQuickAddModal = false; const newIndex = mission.tasklists[targetTlIndex].todos.length - 1; this.openEditModal(mission, targetTlIndex, newIndex, isIdeaBox); },
                async addTodoDirectly(mission, tlIndex, event) { const content = event.target.value.trim(); if (!content) return; const newItem = { id: this.generateId(), content: content, money: 0, status: 'doing', note: '', startTime: new Date().toISOString().slice(0, 10), endTime: '', isLoop: false, logs: [] }; mission.tasklists[tlIndex].todos.push(newItem); await this.updateMission(mission); event.target.value = ''; const newIndex = mission.tasklists[tlIndex].todos.length - 1; this.openEditModal(mission, tlIndex, newIndex, false); },
                async addIdeaDirectly(mission, event) { const content = event.target.value.trim(); if (!content) return; if(mission.tasklists.length === 0) mission.tasklists.push({ id: this.generateId(), title: "√ù t∆∞·ªüng", todos: [] }); const newItem = { id: this.generateId(), content: content, money: 0, status: 'idea', note: '', startTime: '', endTime: '' }; mission.tasklists[0].todos.push(newItem); await this.updateMission(mission); event.target.value = ''; const newIndex = mission.tasklists[0].todos.length - 1; this.openEditModal(mission, 0, newIndex, true); },
                openEditModal(mission, tlIndex, tIndex, isIdea) { const todo = mission.tasklists[tlIndex].todos[tIndex]; this.editingTodo = { mission, tlIndex, tIndex, isIdea: isIdea }; this.editForm = { ...todo, note: todo.note || '', startTime: todo.startTime ? todo.startTime.slice(0,10) : '', endTime: todo.endTime ? todo.endTime.slice(0,10) : '', isLoop: !!todo.isLoop, logs: todo.logs || [] }; this.moveTarget = { missionId: '', tasklistId: '' }; },
                closeEditModal() { this.editingTodo = null; },
                async checkInLoop() { if (!this.editForm.logs) this.editForm.logs = []; this.editForm.logs.push(new Date().toISOString()); await this.saveEdit(); this.triggerConfetti(0.5, 'regular'); this.showToast("Gi·ªØ v·ªØng phong ƒë·ªô nh√©!", '<i class="fas fa-check-circle"></i>', "ƒê√£ ghi nh·∫≠n"); },
                triggerConfetti(intensity, type) { if (typeof confetti === 'function') { if (type === 'gold') { const defaults = { spread: 360, ticks: 100, gravity: 0, decay: 0.94, startVelocity: 30, shapes: ['star'], colors: ['#FFE400', '#FFBD00', '#E89400', '#FFCA6C', '#FDFFB8'] }; function shoot() { confetti({ ...defaults, particleCount: 40, scalar: 1.2, shapes: ['star'] }); confetti({ ...defaults, particleCount: 10, scalar: 0.75, shapes: ['circle'] }); } setTimeout(shoot, 0); setTimeout(shoot, 100); setTimeout(shoot, 200); } else { confetti({ particleCount: intensity * 100, spread: 70, origin: { y: 0.6 } }); } } },
                showToast(msg, icon = '<i class="fas fa-crown"></i>', title = "Tuy·ªát v·ªùi") { this.toast.message = msg; this.toast.icon = icon; this.toast.title = title; this.toast.show = true; setTimeout(() => this.toast.show = false, 4000); },
                checkCompletion(mission, tlIndex, todo) { if (mission.title.includes("H·ªôp √Ω t∆∞·ªüng")) return; if (todo.startTime && todo.startTime.length >= 10) { const start = new Date(todo.startTime); const now = new Date(); const diffTime = Math.abs(now - start); const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)); if (diffDays > 3) { this.triggerConfetti(1, 'gold'); this.showToast(`B·∫°n ƒë√£ theo ƒëu·ªïi vi·ªác n√†y ${diffDays} ng√†y!`, '<i class="fas fa-mountain"></i>', "S·ª± ki√™n tr√¨ ƒë√°ng n·ªÉ"); return; } } const tasklist = mission.tasklists[tlIndex]; const allTodosDone = tasklist.todos.length > 0 && tasklist.todos.every(t => t.status === 'done' || t.status === 'cancel'); if (allTodosDone) { const allTasklistsDone = mission.tasklists.every(tl => tl.todos.length > 0 && tl.todos.every(t => t.status === 'done' || t.status === 'cancel')); if (allTasklistsDone) { this.triggerConfetti(2.5, 'regular'); this.celebrationMessage = "B·∫°n ƒë√£ chinh ph·ª•c ƒë∆∞·ª£c m·ª•c ti√™u l·ªõn!"; this.completedMissionTitle = mission.title; this.showCelebrationModal = true; } else { this.triggerConfetti(1.0, 'regular'); this.showToast(`ƒê√£ xong nh√≥m vi·ªác "${tasklist.title}"`, '<i class="fas fa-check-double"></i>', "Ho√†n th√†nh nh√≥m"); } } else { this.triggerConfetti(0.3, 'regular'); const praises = ["L√†m t·ªët l·∫Øm!", "Ti·∫øp t·ª•c nh√©!", "Xu·∫•t s·∫Øc!", "Qu√° d·ªØ!", "1 like cho b·∫°n!"]; this.showToast(praises[Math.floor(Math.random() * praises.length)], '<i class="fas fa-thumbs-up"></i>', "Xong 1 vi·ªác"); } },
                async saveEdit() { if (!this.editingTodo) return; const { mission, tlIndex, tIndex } = this.editingTodo; const oldStatus = mission.tasklists[tlIndex].todos[tIndex].status; const updatedTodo = { ...mission.tasklists[tlIndex].todos[tIndex], ...this.editForm }; mission.tasklists[tlIndex].todos[tIndex] = updatedTodo; await this.updateMission(mission); if (oldStatus !== 'done' && this.editForm.status === 'done') this.checkCompletion(mission, tlIndex, updatedTodo); if(!this.showQuickAddModal) this.closeEditModal(); },
                onMoveMissionChange() { this.moveTarget.tasklistId = ''; if (this.targetMission && this.targetMission.tasklists.length > 0) this.moveTarget.tasklistId = this.targetMission.tasklists[0].id; },
                async moveTodo() { if (!this.moveTarget.missionId || !this.moveTarget.tasklistId) return; const sourceMission = this.editingTodo.mission; const sourceTlIndex = this.editingTodo.tlIndex; const sourceTIndex = this.editingTodo.tIndex; const targetMission = this.missions.find(m => m.id === this.moveTarget.missionId); if (!targetMission) return; const targetTlIndex = targetMission.tasklists.findIndex(tl => tl.id === this.moveTarget.tasklistId); if (targetTlIndex === -1) return; const todoToMove = { ...sourceMission.tasklists[sourceTlIndex].todos[sourceTIndex] }; const isSourceIdea = sourceMission.title.includes("H·ªôp √Ω t∆∞·ªüng"); const isTargetIdea = targetMission.title.includes("H·ªôp √Ω t∆∞·ªüng"); if (isSourceIdea && !isTargetIdea) { todoToMove.status = 'doing'; if (!todoToMove.startTime) todoToMove.startTime = new Date().toISOString().slice(0, 10); } else if (!isSourceIdea && isTargetIdea) { todoToMove.status = 'idea'; } sourceMission.tasklists[sourceTlIndex].todos.splice(sourceTIndex, 1); if (sourceMission.id === targetMission.id) { sourceMission.tasklists[targetTlIndex].todos.push(todoToMove); await this.updateMission(sourceMission); } else { targetMission.tasklists[targetTlIndex].todos.push(todoToMove); await this.updateMission(sourceMission); await this.updateMission(targetMission); } this.showToast("ƒê√£ chuy·ªÉn th√†nh c√¥ng!", '<i class="fas fa-exchange-alt"></i>', "Th√†nh c√¥ng"); this.closeEditModal(); },
                async deleteEditingTodo() { if(!confirm("X√≥a?")) return; const { mission, tlIndex, tIndex } = this.editingTodo; mission.tasklists[tlIndex].todos.splice(tIndex, 1); await this.updateMission(mission); this.closeEditModal(); },
                addTasklist(mission, event) { if (!event.target.value.trim()) return; mission.tasklists.push({ id: this.generateId(), title: event.target.value, todos: [] }); this.updateMission(mission); event.target.value = ''; },
                deleteTasklist(mission, tlIndex) { if(confirm('X√≥a danh s√°ch?')) { mission.tasklists.splice(tlIndex, 1); this.updateMission(mission); } },
                exportData(type) { alert("S·∫µn s√†ng!"); this.showMenu = false; }, 
                async importData(event) { const file = event.target.files[0]; if (!file) return; const reader = new FileReader(); reader.onload = async (e) => { try { const content = e.target.result; const data = JSON.parse(content); if (!Array.isArray(data)) throw new Error("File JSON kh√¥ng h·ª£p l·ªá"); this.loading = true; this.showMenu = false; let count = 0; for (const m of data) { const newMission = { title: m.title || "Untitled", createdAt: Date.now() + count, tasklists: m.tasklists || [] }; await addDoc(collection(db, "missions"), newMission); count++; } this.showToast(`ƒê√£ nh·∫≠p th√†nh c√¥ng ${count} m·ª•c ti√™u!`, '<i class="fas fa-file-import"></i>', "Import th√†nh c√¥ng"); } catch (err) { console.error(err); alert("L·ªói khi ƒë·ªçc file: " + err.message); } finally { this.loading = false; } }; reader.readAsText(file); event.target.value = ''; },
                filteredTodos(todos) { if (this.filterStatus === 'all') return todos; if (this.filterStatus === 'money') return todos.filter(t => t.money !== 0); if (this.filterStatus === 'loop') return todos.filter(t => t.isLoop); return todos.filter(t => t.status === this.filterStatus); }
            }
        }).mount('#app');
    </script>
</body>
</html>